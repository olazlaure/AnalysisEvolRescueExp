---
title: "Evolutionary rescue experiment: effect of genetic diversity"
author: "Laure Olazcuaga"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```


    

# DATA
## Pop sive over time dataset
```{r }
data <- read.table(file=here::here("data", "BE_Census_Data.csv"), sep=",", header=TRUE)
  
head(data)
tail(data)
dim(data)
summary(data)

#Remove populations killed due to the pathogen
data_kill<-data[data$Extinction_finalstatus=="kill",]
dim(data_kill)
data<-data[data$Extinction_finalstatus!="kill",]

#Add pop growth rate
data$Nb_adults <- data$HC_Total_Adults
data$Lambda <- data$Nb_adults / data$Nb_parents
data$obs<-as.factor(1:nrow(data))
#summary(data)
#Remove 

#Check variables
str(data)
data$Genetic_Diversity <- as.factor(data$Genetic_Diversity)
data$Block <- as.factor(data$Block)
data$Population <- as.factor(data$Population)
data$Extinction_finalstatus <- as.factor(data$Extinction_finalstatus)


#Order levels 
data$Genetic_Diversity <- plyr::revalue(data$Genetic_Diversity, c("Med"="Medium"))
data$Genetic_Diversity <- factor(data$Genetic_Diversity, levels = c("High", "Medium", "Low"))
levels(data$Genetic_Diversity)

data<-droplevels(data) #remove previous levels 
str(data)
head(data)
tail(data)


``` 


## Remaining heterozygosity
```{r }
#Upload growth rate end of experiment
data_he <- read.table(file=here::here("data", "He_ReMaining_BeatricePop.csv"), sep=",", header=TRUE)
data_he$Population <- as.factor(data_he$Population)
data_he <- data_he[,c(1,3)]


### Additional: He remaining 
# New vector for the lost during exp
data_he$He_remain_exp <- NA

# He lost during exp
for(i in levels(data$Population)){
temp_data_pop <- subset(data, Population==i)
ifelse(sum(temp_data_pop$Generation_Parents)!=15,print("ERROR"),print(i))
temp_he_remaining_gen <- 1 - (1/(2*temp_data_pop$Nb_parents))
temp_he_remain_exp <- prod(temp_he_remaining_gen, na.rm = TRUE)
data_he$He_remain_exp[data_he$Population==i] <- temp_he_remain_exp
rm(temp_he_remain_exp,temp_he_remaining_gen,temp_data_pop)
}

# Remaining He at the end of the experiment
data_he$He_remain_end <- data_he$He_remain * data_he$He_remain_exp

```




## Phenotyping dataset
```{r }
#Upload growth rate end of experiment
data_phenotyping <- read.table(file=here::here("data", "Adaptation_Data.csv"), sep=",", header=TRUE)


#Factors variables 
data_phenotyping$ID_Rep <- as.factor(data_phenotyping$ID_Rep)
data_phenotyping$Week <- as.factor(data_phenotyping$Week)
data_phenotyping$Block <- as.factor(data_phenotyping$Block)
data_phenotyping$Population <- as.factor(data_phenotyping$Population)
#Revalue
data_phenotyping$Genetic_Diversity <- as.factor(data_phenotyping$Divsersity)
data_phenotyping$Genetic_Diversity <-   plyr::revalue(data_phenotyping$Genetic_Diversity, c("Med"="Medium"))
data_phenotyping$Genetic_Diversity <- factor(data_phenotyping$Genetic_Diversity, levels = c("High", "Medium", "Low"))



#Add sum total 
data_phenotyping$Nb_ttx <- rowSums(data_phenotyping[,11:13], na.rm=TRUE)
#Proportion
data_phenotyping$p_adults <- data_phenotyping$Adults  / data_phenotyping$Nb_ttx
data_phenotyping$p_pupae <- data_phenotyping$Pupae / data_phenotyping$Nb_ttx
data_phenotyping$p_larvae <- data_phenotyping$Larvae / data_phenotyping$Nb_ttx

data_phenotyping_all <- data_phenotyping
data_phenotyping <- data_phenotyping[data_phenotyping$Week=="5-week",]

``` 


## Merge dataset He
```{r }
#Add heterozygosity
data <- merge(x = data, y = data_he, by = "Population", all.x=TRUE)

#Add heterozygosity
data_phenotyping <- merge(x = data_phenotyping, y = data_he, by = "Population", all.x=TRUE)

``` 


## Subset dataset generation
```{r }
#Data beginning
data_G2 <- data[data$Generation_Eggs==2,]
#Data end 
data_G6 <- data[data$Generation_Eggs==6,]

``` 


## Merge dataset phenotyping
```{r }
## Merge dataset phenotyping
#merge dataset
temp_Start <- data_G2[,c("Block","Population",
                         "Genetic_Diversity","Lambda", "He_remain", "He_remain_end" )]
temp_Start$ID_Rep <- 1
temp_Start$Phenotyping <- "Initial"

temp_end <- data_phenotyping[,c("Block","Population",
                                "Genetic_Diversity","Lambda","ID_Rep", "He_remain", "He_remain_end" )]
temp_end$Phenotyping <- "Final"

data_evolution_Lambda <- rbind(temp_Start,temp_end)
data_evolution_Lambda$Phenotyping <- factor(data_evolution_Lambda$Phenotyping, 
                                            levels = c("Initial", "Final"))


``` 

# PLOT 
## Population size
```{r }
PLOT_Pop_size<-ggplot2::ggplot(data, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Population,
                                colour = Genetic_Diversity)) + 
  geom_point(position = position_dodge(0.4), size = 0.8, alpha = 0.7) +
  geom_line(position = position_dodge(0.4), size = 0.2, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size
# cowplot::save_plot(file = here::here("figures","OldPlot_PopulationSize.pdf"),PLOT_Pop_size, base_height = 10/cm(1),
#           base_width = 15/cm(1), dpi = 610)



SUM_Popsize <- Rmisc::summarySE(data, 
                        measurevar = c("Nb_adults"),
                       groupvars = c("Generation_Eggs",
                                     "Genetic_Diversity"), 
                       na.rm=TRUE)
SUM_Popsize
PLOT_Pop_size_average <- PLOT_Pop_size + 
  geom_point(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 5, position = position_dodge(0.4)) +
  geom_errorbar(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                ymin = Nb_adults-ci, ymax = Nb_adults+ci, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 1, width=.2,  position = position_dodge(0.4)) +
  geom_line(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
           linetype = "dashed", size = 1.5, position = position_dodge(0.4)) 
PLOT_Pop_size_average
# cowplot::save_plot(file = here::here("figures","OldPlot_PopulationSize_average.pdf"),   PLOT_Pop_size_average, base_height = 10/cm(1),           base_width = 15/cm(1), dpi = 610)

``` 




## Extinction
```{r }
## Extinction yes no
PLOT_Extinction<-ggplot2::ggplot(data, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Population,
                                colour = Extinction_finalstatus)) + 
  facet_wrap(~Genetic_Diversity, ncol=3) + 
  #geom_point(position = position_dodge(0.4), size = 0.4, alpha = 0.7) +
  geom_line(position = position_dodge(0.1), size = 0.4, alpha = 0.8) +
  ylab("Population size") +
  scale_color_manual(values = c("black", "red")) +
  xlab("Generation") +
  theme(legend.position = "none") +
  theme_LO
PLOT_Extinction
# #
# cowplot::save_plot(here::here("figures","OldPlot_Extinction.pdf"),   PLOT_Extinction, base_height = 6/cm(1),
#           base_width = 20/cm(1), dpi = 610)
# 
# #



``` 



## Growth rate
```{r }
tapply(data_G2$Lambda,data_G2$Genetic_Diversity,mean)

PLOT_Growth<-ggplot2::ggplot(data_G2, aes(x = Genetic_Diversity, y = Lambda, 
                         colour = Genetic_Diversity)) + 
  geom_boxplot(aes(group = Genetic_Diversity),outlier.colour = NA) +
  geom_jitter(width = 0.25, size = 1, alpha = 0.8) +
  ylab("Growth rate") +
  theme(legend.position = "none") +
  xlab("Genetic diversity") +
  theme_LO
PLOT_Growth
# 
# cowplot::save_plot(here::here("figures","OldPlot_Growth_Start.pdf"),   PLOT_Growth, base_height = 10/cm(1),
#           base_width = 8/cm(1), dpi = 610)



``` 



## Growth rate evolution
```{r }

SUM_MEAN_start_end <- Rmisc::summarySE(data_evolution_Lambda, measurevar = c("Lambda"),
                       groupvars = c("Genetic_Diversity","Phenotyping"), 
                       na.rm=TRUE)
SUM_POP_start_end <- Rmisc::summarySE(data_evolution_Lambda, measurevar = c("Lambda"),
                       groupvars = c("Genetic_Diversity","Phenotyping",
                                     "Population"), 
                       na.rm=TRUE)





PLOT_Growth_startend<-ggplot(SUM_POP_start_end, aes(x = Phenotyping, 
                                 y = Lambda, 
                                 group = Population,
                                 colour = Genetic_Diversity)) + 
  geom_point(position = position_dodge(0.4), size = 0.8, alpha = 0.7) +
  geom_line(position = position_dodge(0.4), size = 0.2, alpha = 0.6) +
  ylab("Growth rate") +
  xlab("Phenotyping") +
  theme_LO
PLOT_Growth_startend

PLOT_Growth_startend_average <- PLOT_Growth_startend + 
  geom_point(data = SUM_MEAN_start_end, aes(x = Phenotyping, 
                                y = Lambda, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 5, position = position_dodge(0.4)) +
  geom_errorbar(data = SUM_MEAN_start_end, aes(x = Phenotyping, 
                                ymin = Lambda-ci, ymax = Lambda+ci, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 1, width=.2,  position = position_dodge(0.4)) +
  geom_line(data = SUM_MEAN_start_end, aes(x = Phenotyping, 
                                y = Lambda, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
           linetype = "dashed", size = 1.5, position = position_dodge(0.4)) 
PLOT_Growth_startend_average
# 
# cowplot::save_plot(here::here("figures","OldPlot_Lambda_Evolution.pdf"),
#           PLOT_Growth_startend_average, base_height = 10/cm(1),
#           base_width = 15/cm(1), dpi = 610)
``` 


## Life stage proportion
```{r }
SUM_Prop_adults<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_adults"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_adults

SUM_Prop_pupae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_pupae"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_pupae

SUM_Prop_larvae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_larvae"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_larvae

SUM_Prop <- data.frame(SUM_Prop_adults[,1:4],
                       p_pupae=SUM_Prop_pupae$p_pupae,
                       p_larvae=SUM_Prop_larvae$p_larvae)


SUM_Prop<-tidyr::gather(SUM_Prop,"Stage", "Proportion",4:6,-"Genetic_Diversity")
SUM_Prop
SUM_Prop$Stage <- factor(SUM_Prop$Stage, levels = c("p_adults", "p_pupae", "p_larvae"))


PLOT_prop <- ggplot2::ggplot(data = SUM_Prop, aes(x = Genetic_Diversity, 
                                                  y = Proportion, fill = Stage)) +
  facet_wrap(~ Week, ncol=2) +
  geom_bar(stat="identity") + 
  xlab("Level of genetic diversity") +
  labs(color="Stage of individuals") +
  ylab("Proportion of each stage") +
  scale_fill_manual(values= c("#4EABB9", "#E95C2B", "#CBA938"), 
                    breaks = c("p_adults", "p_pupae", "p_larvae"),
                    labels = c( "Adult", "Pupae","Larvae")) + 
  theme_LO
PLOT_prop

# cowplot::save_plot(here::here("figures","OldPlot_Life_stage_proportion.pdf"),   PLOT_prop,
#           base_height = 8/cm(1), base_width = 16/cm(1), dpi = 610)
# 

``` 


## Remaining heterozygosity
```{r }

# All but with: He beginning for both and with pseudoreplication for final
ggplot2::ggplot(data_evolution_Lambda, aes(x = He_remain, y = Lambda, 
                         colour = Genetic_Diversity)) + 
  facet_wrap(~ Phenotyping, ncol = 1)+
  geom_point(size = 2, alpha = 0.8) +
  ylab("Growth rate") +
  theme(legend.position = "none") +
  xlab("Remaining heterozygosity") +
  theme_LO



PLOT_He_Initial <- ggplot2::ggplot(data_G2, aes(x = He_remain, y = Lambda, 
                         colour = Genetic_Diversity)) + 
  geom_point(size = 2, alpha = 0.8) +
  ylab("Growth rate") +
  theme(legend.position = "none") +
  xlab("Remaining heterozygosity") +
  theme_LO
PLOT_He_Initial


# Remove pseudoreplication: average of each population
SUM_POP_He_Mean<- Rmisc::summarySE(data_evolution_Lambda[data_evolution_Lambda$Phenotyping=="Final",],
                            measurevar = c("Lambda"),
                       groupvars = c("Genetic_Diversity","He_remain_end",
                                     "Population"), 
                       na.rm=TRUE)

PLOT_He_Final <- ggplot2::ggplot(SUM_POP_He_Mean, aes(x = He_remain_end, y = Lambda, 
                         colour = Genetic_Diversity)) + 
  geom_point(size = 2, alpha = 0.8) +
  ylab("Growth rate") +
  theme(legend.position = "none") +
  xlab("Remaining heterozygosity") +
  theme_LO
PLOT_He_Final




# ALL WITHOUT PSEUDO
SUM_POP_He_ALL<- Rmisc::summarySE(data_evolution_Lambda,
                            measurevar = c("Lambda"),
                       groupvars = c("Genetic_Diversity","Phenotyping", "He_remain", "He_remain_end",
                                     "Population"), 
                       na.rm=TRUE)

SUM_POP_He_ALL$HE <- ifelse(SUM_POP_He_ALL$Phenotyping=="Initial",SUM_POP_He_ALL$He_remain,SUM_POP_He_ALL$He_remain_end)


PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda, 
                         colour = Genetic_Diversity, 
                         shape = Phenotyping)) + 
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(1, 19)) + 
  ylab("Growth rate") +
  xlab("Remaining heterozygosity") +
  theme_LO
PLOT_He_ALL

# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",], aes(x = HE, y = Lambda,
#                          colour = Genetic_Diversity,
#                          shape = Phenotyping)) +
#   geom_point(size = 3, alpha = 0.8) +
#   scale_shape_manual(values = c(19)) +
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO
# PLOT_He_ALL





``` 

# ANALYSIS 
## Probability of extinction
```{r }
############ 
###### Clean dataset
############ 
#Prepare clean dataset
data_proba_extinction <- data_G6[,c("Block","Population","Genetic_Diversity","Extinction_finalstatus")]
data_proba_extinction$Extinction_finalstatus <- as.factor(data_proba_extinction$Extinction_finalstatus)
data_proba_extinction$y <- ifelse(data_proba_extinction$Extinction_finalstatus == "yes", 1, 0)



############ 
###### Analysis
############ 
#Analysis
mod0 <- lme4::glmer(y ~ Genetic_Diversity + Block + (1|Population),  
      data = data_proba_extinction, family = binomial)


summary(mod0)


#Test genetic diversity effect
mod1 <- lme4::glmer(y ~ Block + (1|Population),  
      data = data_proba_extinction, family = binomial)
anova(mod0, mod1, test = "Chisq")
#We keep genetic diversity 


mod0 <- lme4::glmer(y ~ Genetic_Diversity-1 + Block + (1|Population),  
      data = data_proba_extinction, family = binomial)
summary(mod0)



############ 
###### Predicted value
############ 
#Extract probability of extinction 
(p_high <- plogis(-3.950e+01))
(p_med <- plogis(-3.014e+00))
(p_low <- plogis(-2.808e+00))



predict(mod0, type = "response", 
        re.form = NA,
        newdata = data.frame(Genetic_Diversity = levels(data_proba_extinction$Genetic_Diversity), 
                             Block = "Block4"))
        

############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


``` 



## Population size G6
```{r }

############ 
###### Analysis
############ 
#Analysis
# mod0 <- lme4::glmer(Nb_adults ~ Genetic_Diversity + Block + (1|Population),  
#       data = data_G6, family = "poisson")


mod0 <- lm(log(Nb_adults) ~ Genetic_Diversity + Block, 
             data = data_G6[data_G6$Extinction_finalstatus == "no",])


mod1 <- lm(log(Nb_adults) ~ Block , 
             data = data_G6[data_G6$Extinction_finalstatus == "no",])

anova(mod0, mod1) # Effect of genetic diversity 

mod0 <- lm(log(Nb_adults) ~ Genetic_Diversity + Block, 
             data = data_G6[data_G6$Extinction_finalstatus == "no",])


summary(mod0)


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 

``` 



## Population size over time
```{r }

PLOT_Pop_size_average
fit <- glm(Nb_adults ~ Generation_Eggs, data = data, family = "poisson")
#second degree
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), data = data, family = "poisson")
#third degree
fit3 <- glm(Nb_adults~stats::poly(Generation_Eggs,3,raw=TRUE), data = data, family = "poisson")
#fourth degree
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), data = data, family = "poisson")
#fourth degree
fit5 <- glm(Nb_adults~stats::poly(Generation_Eggs,5,raw=TRUE), data = data, family = "poisson")
#exp
fit6 <- glm(Nb_adults~exp(Generation_Eggs), data = data, family = "poisson")
#log
fit7 <- glm(Nb_adults~log(Generation_Eggs), data = data, family = "poisson")


#generate range of 50 numbers starting from 30 and ending at 160
xx <- seq(1,6, length=100)
plot(data$Generation_Eggs,
     data$Nb_adults,pch=19)
lines(xx, predict(fit, data.frame(Generation_Eggs=xx),type = "response"), col="red")
lines(xx, predict(fit2, data.frame(Generation_Eggs=xx),type = "response"), col="green")
lines(xx, predict(fit3, data.frame(Generation_Eggs=xx),type = "response"), col="blue")
lines(xx, predict(fit4, data.frame(Generation_Eggs=xx),type = "response"), col="purple")
lines(xx, predict(fit5, data.frame(Generation_Eggs=xx),type = "response"), col="yellow")
lines(xx, predict(fit6, data.frame(Generation_Eggs=xx),type = "response"), col="orange")
lines(xx, predict(fit7, data.frame(Generation_Eggs=xx),type = "response"), col="pink")

# Check the r squared
summary(fit)$adj.r.squared
summary(fit2)$adj.r.squared
summary(fit3)$adj.r.squared
summary(fit4)$adj.r.squared # best r square
summary(fit5)$adj.r.squared 
summary(fit6)$adj.r.squared 
summary(fit7)$adj.r.squared 


#
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), data = data, family = "poisson")



#If we dont consider Gen=1 
PLOT_Pop_size_average
fit <- lm(log(Nb_adults+1) ~ Generation_Eggs, data = data[data$Generation_Eggs>=2,])
#second degree
fit2 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,2,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#third degree
fit3 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,3,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#fourth degree
fit4 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,4,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#fourth degree
fit5 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,5,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#exp
fit6 <- lm(log(Nb_adults+1)~exp(Generation_Eggs), data = data[data$Generation_Eggs>=2,])
#log
fit7 <- lm(log(Nb_adults+1)~log(Generation_Eggs), data = data[data$Generation_Eggs>=2,])
#generate range of 50 numbers starting from 30 and ending at 160
xx <- seq(1,6, length=100)
plot(data[data$Generation_Eggs>=2,]$Generation_Eggs,
     log(data[data$Generation_Eggs>=2,]$Nb_adults+1),pch=19,ylim=c(0,8))
lines(xx, predict(fit, data.frame(Generation_Eggs=xx)), col="red")
lines(xx, predict(fit2, data.frame(Generation_Eggs=xx)), col="green")
lines(xx, predict(fit3, data.frame(Generation_Eggs=xx)), col="blue")
lines(xx, predict(fit4, data.frame(Generation_Eggs=xx)), col="purple")
lines(xx, predict(fit5, data.frame(Generation_Eggs=xx)), col="yellow")
lines(xx, predict(fit6, data.frame(Generation_Eggs=xx)), col="orange")
lines(xx, predict(fit7, data.frame(Generation_Eggs=xx)), col="pink")
# Check the r squared
summary(fit)$adj.r.squared
summary(fit2)$adj.r.squared
summary(fit3)$adj.r.squared
summary(fit4)$adj.r.squared # best r square
summary(fit5)$adj.r.squared 
summary(fit6)$adj.r.squared 
summary(fit7)$adj.r.squared 



# data$gen_square <- data$Generation_Eggs^2
# fit2 <- lm(log(Nb_adults+1)~poly(Generation_Eggs,2,raw=TRUE), data = data[data$Generation_Eggs>=2,])
# fit2 <- lm(log(Nb_adults+1)~ Generation_Eggs + gen_square, data = data[data$Generation_Eggs>=2,])
# #Add the interaction with Genetic diversity 
# fit2 <- glm(Nb_adults~ Generation_Eggs*Genetic_Diversity + 
#              gen_square*Genetic_Diversity, 
#            data = data, family = "poisson")
# 
# 
# summary(fit2)


####################### 
####################### MODEL INCLUDING GENETIC DIVERSITY 
####################### 

#Test oversdispersion
fit4 <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + (1|Block), data = data, family = "poisson")
blmeco::dispersion_glmer(fit4)

mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
blmeco::dispersion_glmer(mod)


#Convergence issue 
max(abs(with(mod@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001

#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(1,6, length = 100),each=3),
                       Block = "Block4", 
                       Estimates = NA)
filldata$Estimates <- predict(fit4, newdata=filldata, type = "response")


#Plot
PLOT_Pop_size <- ggplot2::ggplot(data = data) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.3) +
  geom_point(data = data, 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size




# fit2 <- lm(log(Nb_adults+1)~ Generation_Eggs*Genetic_Diversity + 
#              gen_square*Genetic_Diversity, 
#            data = data[data$Generation_Eggs>=2,])
# fit2_test <- lm(log(Nb_adults+1)~ Generation_Eggs+Genetic_Diversity + 
#              gen_square, 
#            data = data[data$Generation_Eggs>=2,])

mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
mod1 <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)+Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
anova(mod,mod1, test = "Chisq")
#Signifcant interaction 
summary(mod)
summary(mod1)


emmeans::emmeans(mod, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


####################### 
####################### MODEL INCLUDING ONLY RESCUED POPULATIONS
####################### 
#Same but only for population not extinct
fit_fin <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity,
            data = data[data$Extinction_finalstatus=="no",], family = "poisson")

filldata$Estimates_Withoutextpop <- predict(fit_fin, newdata=filldata, type = "response")

PLOT_Pop_size <- ggplot2::ggplot(data = data) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates_Withoutextpop, 
                               colour = Genetic_Diversity), size = 1.5, linetype = "longdash") +
  geom_point(data = data[data$Extinction_finalstatus=="no",], 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.5) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size




mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), 
             data = data[data$Extinction_finalstatus=="no",], family = "poisson")
mod1 <- lme4::glmer(Nb_adults~poly(Generation_Eggs,4,raw=TRUE)+Genetic_Diversity + 
               (1|Block) + (1|obs), 
              data = data[data$Extinction_finalstatus=="no",], family = "poisson")
anova(mod,mod1, test = "Chisq")


summary(mod)

emmeans::emmeans(mod, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#Signifcant interaction 
``` 


## Evolution of fitness over time
```{r }
############ 
###### Distribution
############
hist(data_evolution_Lambda$Lambda, breaks=50)


# Square root
msqrt <- lme4::lmer(sqrt(Lambda) ~ Genetic_Diversity*Phenotyping  + 
                Block + (1|Population), 
              data = data_evolution_Lambda)
summary(msqrt)

# log
mlog <- lme4::lmer(log(Lambda+1) ~ Genetic_Diversity*Phenotyping  +
               Block + (1|Population),
              data=data_evolution_Lambda)

# Normal
mnorm <- lme4::lmer(Lambda ~ Genetic_Diversity*Phenotyping  + 
                Block + (1|Population),
              data=data_evolution_Lambda)

## Compare AIC
AIC(mlog, msqrt,mnorm)
#Square root a better fits to the data 
#But we compare different values: Growth rate and Growth rate+1

#Distribution Residuals
hist(residuals(mlog),col="yellow",freq=F)
hist(residuals(msqrt),col="yellow",freq=F)  #Seems the better fit
hist(residuals(mnorm),col="yellow",freq=F)

#Test normality
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(mlog), "norm"))
g1$kstest 
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(msqrt), "norm"))
g1$kstest 
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(mnorm), "norm"))
g1$kstest

# QQ plot
# plot(mlog, which = 2) 
# plot(msqrt, which = 2) #Seems the better fit!
# plot(mnorm, which = 2) #Seems the better fit but very high AIC 
qqnorm(resid(mlog))
qqline(resid(mlog))

qqnorm(resid(msqrt))
qqline(resid(msqrt))

qqnorm(resid(mnorm))
qqline(resid(mnorm)) #best fit

############ 
###### Model selection
############

m0 <- lme4::lmer(Lambda ~ Genetic_Diversity*Phenotyping  + 
                Block + (1|Population) ,
              data=data_evolution_Lambda)


m1 <- lme4::lmer(Lambda ~ Genetic_Diversity+Phenotyping  + 
                Block + (1|Population) ,
              data=data_evolution_Lambda)

anova(m0,m1,test="Chisq") #Remove interaction


#Same result with: 
# m1 <- lmer(Lambda ~ Genetic_Diversity+Phenotyping  + 
#                 (1|Block) + (1|Population) + (1|ID_Rep:Population),
#               data=data_evolution_Lambda)
# OR
# m1 <- lmer(Lambda ~ Genetic_Diversity+Phenotyping  + 
#                (1|Block) + (1|Population) ,
#               data=data_evolution_Lambda)

m2 <- lme4::lmer(Lambda ~ Phenotyping  + 
                Block + (1|Population),
              data=data_evolution_Lambda)
m3 <- lme4::lmer(Lambda ~ Genetic_Diversity  + 
                Block + (1|Population),
              data=data_evolution_Lambda)

anova(m1,m2,test="Chisq") #Keep phenotyping
anova(m1,m3,test="Chisq") #Keep genetic diversity

############ 
###### Posthoc
############ 
mod_final <- lme4::lmer(Lambda ~ Genetic_Diversity+Phenotyping  + 
                Block + (1|Population),
              data=data_evolution_Lambda)

emmeans::emmeans(mod_final, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 
emmeans::emmeans(mod_final, list(pairwise ~ Phenotyping), adjust = "tukey") #

#
``` 



## Fitness G6 
```{r }
m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
summary(m0)

# Equivalent to:
# m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population/ID_Rep),
#                 family = "poisson", data = data_5week)


#dispersion_lme4::glmer(m0) #dispersion ok 
#Note: (1|School) + (1|Class:School) is equivalent to (1|School/Class)

m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") # difference

summary(m0)




############ 
###### Posthoc
############ 
emmeans::emmeans(m0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#test double nested
m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Genetic_Diversity/Population/ID_Rep),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Genetic_Diversity/Population/ID_Rep),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") 

m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Genetic_Diversity/ID_Rep),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Genetic_Diversity/ID_Rep),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") 

``` 



## Fitness G2 
```{r }
m0 <- glm(Nb_adults ~ Genetic_Diversity + Block,  family = "poisson", data = data_G2)
summary(m0)

m1<- glm(Nb_adults ~ Block,  family = "poisson", data = data_G2)
anova(m0,m1,test="Chisq") # difference

############ 
###### Posthoc
############ 
emmeans::emmeans(m0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


``` 


## Remaining He difference
```{r }

Rmisc::summarySE(data_G2,
          measurevar = c("He_remain"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)


mfull <- lm(He_remain ~ Genetic_Diversity, data=data_G2)
mless <- lm(He_remain ~ 1, data=data_G2)
anova(mfull,mless) #Keep effect



############ 
###### Posthoc
############ 
emmeans::emmeans(mfull, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 



Rmisc::summarySE(data_G2,
          measurevar = c("He_remain"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)




#Calcul for end:
Rmisc::summarySE(data_G2[data_G2$Extinction_finalstatus!="yes",],
          measurevar = c("He_remain_end"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)

mfull <- lm(He_remain_end ~ Genetic_Diversity, data=data_G2[data_G2$Extinction_finalstatus!="yes",])
mless <- lm(He_remain_end ~ 1, data=data_G2[data_G2$Extinction_finalstatus!="yes",])
anova(mfull,mless) #Keep effect



############ 
###### Posthoc
############ 
emmeans::emmeans(mfull, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 






```


## Growth rate and He
```{r }
# 
# #fit first degree polynomial equation:
# fit  <- lm(Lambda ~ HE, data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# #same fit as: fit5 <- lm(Lambda~HE+HE^2, data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# #same fit as: fit6 <- lm(Lambda~HE^2, data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# 
# #second degree
# fit2 <- lm(Lambda~poly(HE,2,raw=TRUE), data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# #third degree
# fit3 <- lm(Lambda~poly(HE,3,raw=TRUE), data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# #fourth degree
# fit4 <- lm(Lambda~poly(HE,4,raw=TRUE), data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# #Other fit 
# fit7 <- lm(Lambda~exp(HE), data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# fit8 <- lm(Lambda~log(HE), data = SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",])
# 
# #generate range of 50 numbers starting from 30 and ending at 160
# xx <- seq(0.3,1, length=100)
# plot(SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",]$HE,
#      SUM_POP_He_ALL[SUM_POP_He_ALL$Phenotyping=="Final",]$Lambda,pch=19,ylim=c(0,5))
# lines(xx, predict(fit, data.frame(HE=xx)), col="red")
# lines(xx, predict(fit2, data.frame(HE=xx)), col="green")
# lines(xx, predict(fit3, data.frame(HE=xx)), col="blue")
# lines(xx, predict(fit4, data.frame(HE=xx)), col="purple")
# # lines(xx, predict(fit5, data.frame(HE=xx)), col="black")
# # lines(xx, predict(fit6, data.frame(HE=xx)), col="yellow")
# lines(xx, predict(fit7, data.frame(HE=xx)), col="brown")
# lines(xx, predict(fit8, data.frame(HE=xx)), col="orange")
# 

```