---
title: "Evolutionary rescue experiment: effect of genetic diversity"
author: "Laure Olazcuaga"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()

```


    

# DATA
## Pop sive over time dataset
```{r }
data <- read.table(file=here::here("data", "BE_Census_Data.csv"), sep=",", header=TRUE)
  
head(data)
tail(data)
dim(data)
summary(data)

#Remove populations killed due to the pathogen
data_status  <- data.frame(data$Population,data$Extinction_finalstatus)
data_kill<-data[data$Extinction_finalstatus=="kill",]
dim(data_kill)
data<-data[data$Extinction_finalstatus!="kill",]

#Add pop growth rate
data$Nb_adults <- data$HC_Total_Adults
data$Lambda <- data$Nb_adults / data$Nb_parents
data$obs<-as.factor(1:nrow(data))
#summary(data)
#Remove 

#Check variables
str(data)
data$Genetic_Diversity <- as.factor(data$Genetic_Diversity)
data$Block <- as.factor(data$Block)
data$Population <- as.factor(data$Population)
data$Extinction_finalstatus <- as.factor(data$Extinction_finalstatus)

#Order levels 
data$Genetic_Diversity <- plyr::revalue(data$Genetic_Diversity, c("Med"="Medium"))
data$Genetic_Diversity <- factor(data$Genetic_Diversity, levels = c("High", "Medium", "Low"))
levels(data$Genetic_Diversity)

data<-droplevels(data) #remove previous levels 
str(data)
head(data)
tail(data)
dim(data)



#Add variable 
data$gen_square <- data$Generation_Eggs^2

``` 



## Heterozygosity remain over time 
```{r }
#Upload He dataset
data_he <- read.table(file=here::here("data", "He_ReMaining_BeatricePop.csv"), sep=",", header=TRUE)
data_he$Population <- as.factor(data_he$Population)
data_he <- data_he[,c(1,3)]

#Merge dataset: add heterozygosity data to oridinal data 
data <- merge(x = data, y = data_he, by = "Population", all.x=TRUE)

### Creation of 4 He: 
  # 1- He_start: He was remaining for each population when we started the experiment 
  # 2- He_lost_gen_t: He was lost only during this specfic generation during the experiment  (considering He=1 before this generation)
  # 3- He_remain: He was remaining after each generation (He_remain[Gen=6]=He_end)
  # 4- He_exp: He was lost during the entire experiment (considering He=1 at the beginning of the exp)
  # 5- He_end: He was remaining for each population when we finished the experiment (considering the real He at the beginning of the exp, He_start, not 1)


##### 
##### 1- He_start
#####
colnames(data)[28] <- "He_start"



##### 
##### 2- He_lost_gen_t
##### 
#Add He lost each generation
data$He_lost_gen_t <- 1 - (1/(2*data$Nb_adults))
#To consider extinct populations
is.na(data$He_lost_gen_t) <- sapply (data$He_lost_gen_t, is.infinite)


##### 
##### 3- He_remain
##### 
#Create new variable He remain per generation
data$He_remain <- NA
#Initiate with gen=1: He_start * He_lost_gen1
data$He_remain[data$Generation_Eggs=="1"] <- data$He_start[data$Generation_Eggs=="1"]*
  data$He_lost_gen_t[data$Generation_Eggs=="1"]

#Compute for all the other genrations, except the first one 
for(i in levels(data$Population)){
     ifelse(sum(data$Generation_Eggs[data$Population==i])!=21,print("ERROR"),print(i))
 for(j in 2:max(data$Generation_Eggs)){
   data$He_remain[data$Population==i&data$Generation_Eggs==j] <- 
     data$He_remain[data$Population==i&data$Generation_Eggs==j-1]*
     data$He_lost_gen_t[data$Population==i&data$Generation_Eggs==j]
   }
}




##### 
##### 4- He_exp
##### 
# He at the end of the experiment 
data$He_exp <- NA 

#Compute the HE at the end of the experiment 
for(i in levels(data$Population)){
temp_data_pop <- subset(data, Population==i)
ifelse(sum(temp_data_pop$Generation_Eggs)!=21,print("ERROR"),print(i))
temp_he_remaining_gen <- 1 - (1/(2*temp_data_pop$Nb_adults))
#To consider extinct add this row: 
is.na(temp_he_remaining_gen) <- sapply (temp_he_remaining_gen, is.infinite)
#Compute for the whole experiment 
temp_he_remain_exp <- prod(temp_he_remaining_gen, na.rm = TRUE)
data$He_exp[data$Population==i] <- temp_he_remain_exp
rm(temp_he_remain_exp,temp_he_remaining_gen,temp_data_pop)
}


##### 
##### 5- He_end
##### 
# Remaining He at the end of the experiment
data$He_end <- data$He_start * data$He_exp

#Save these values for Phenotyping 
data_he <- merge(x = data_he, 
                 y = data[data$Generation_Eggs==1,
                          c("Population","He_start",
                             "He_exp","He_end")], 
                 by = "Population", all.x=TRUE)
```


## Phenotyping dataset
```{r }
#Upload growth rate end of experiment
data_phenotyping <- read.table(file=here::here("data", "Adaptation_Data.csv"), sep=",", header=TRUE)


#Factors variables 
data_phenotyping$ID_Rep <- as.factor(data_phenotyping$ID_Rep)
data_phenotyping$Week <- as.factor(data_phenotyping$Week)
data_phenotyping$Block <- as.factor(data_phenotyping$Block)
data_phenotyping$Population <- as.factor(data_phenotyping$Population)
#Revalue
data_phenotyping$Genetic_Diversity <- as.factor(data_phenotyping$Divsersity)
data_phenotyping$Genetic_Diversity <-   plyr::revalue(data_phenotyping$Genetic_Diversity, c("Med"="Medium"))
data_phenotyping$Genetic_Diversity <- factor(data_phenotyping$Genetic_Diversity, 
                                             levels = c("High", "Medium", "Low"))



#Add sum total 
data_phenotyping$Nb_ttx <- rowSums(data_phenotyping[,11:13], na.rm=TRUE)
#Proportion
data_phenotyping$p_adults <- data_phenotyping$Adults  / data_phenotyping$Nb_ttx
data_phenotyping$p_pupae <- data_phenotyping$Pupae / data_phenotyping$Nb_ttx
data_phenotyping$p_larvae <- data_phenotyping$Larvae / data_phenotyping$Nb_ttx

data_phenotyping_4week <- data_phenotyping[data_phenotyping$Week=="4-week",]
data_phenotyping <- data_phenotyping[data_phenotyping$Week=="5-week",]




#Merge with He dataset
data_phenotyping <- merge(x = data_phenotyping, 
              y = data_he, by = "Population", all.x=TRUE)
data_phenotyping_4week <- merge(x = data_phenotyping_4week, 
              y = data_he, by = "Population", all.x=TRUE)

#Clean if less than 30 parents 
pop_possible<-unique(data$Population[data$Generation_Eggs==5&data$Nb_adults>=30])
data_phenotyping <- data_phenotyping[data_phenotyping$Population %in% pop_possible,]

pop_possible<-unique(data$Population[data$Generation_Eggs==4&data$Nb_adults>=30])
data_phenotyping_4week <- data_phenotyping_4week[data_phenotyping_4week$Population %in% pop_possible,]

data_phenotyping_all <- rbind(data_phenotyping,data_phenotyping_4week)


``` 



## Old He remain 
```{r }
# #Upload growth rate end of experiment
# data_he <- read.table(file=here::here("data", "He_ReMaining_BeatricePop.csv"), sep=",", header=TRUE)
# data_he$Population <- as.factor(data_he$Population)
# data_he <- data_he[,c(1,3)]
# 
# 
# ### Additional: He remaining 
# # New vector for the lost during exp
# data_he$He_remain_exp <- NA
# 
# # He lost during exp
# for(i in levels(data$Population)){
# temp_data_pop <- subset(data, Population==i)
# ifelse(sum(temp_data_pop$Generation_Parents)!=15,print("ERROR"),print(i))
# temp_he_remaining_gen <- 1 - (1/(2*temp_data_pop$Nb_parents))
# 
# #To consider extinct add this row: 
# is.na(temp_he_remaining_gen) <- sapply (temp_he_remaining_gen, is.infinite)
# 
# temp_he_remain_exp <- prod(temp_he_remaining_gen, na.rm = TRUE)
# data_he$He_remain_exp[data_he$Population==i] <- temp_he_remain_exp
# rm(temp_he_remain_exp,temp_he_remaining_gen,temp_data_pop)
# }
# 
# # Remaining He at the end of the experiment
# data_he$He_end <- data_he$He_remain * data_he$He_remain_exp
# 
# # Remove kill population 
# data_he <- data_he[!is.na(data_he$He_remain_exp),]
# data_he <- droplevels(data_he)
# 
# ## Merge dataset He
# data_old_merged <- merge(x = data, y = data_he, by = "Population", all.x=TRUE)

```



## Survival data
```{r }
library(survival)
library(lubridate)
library(ggsurvfit)
library("gtsummary")
library("tidycmprsk")
library("condSURV")

#########


data_survival <- data[data$Generation_Parents==0,c("Population","Block","Genetic_Diversity")]
data_survival$Gen_eggs_extinct <- max(data$Generation_Eggs) 
data_survival$Survival <- "yes" 

#Format data
for (i in unique(data_survival$Population)) {
  if (data$Extinction_finalstatus[data$Population==i&data$Generation_Eggs==1] == "yes" ) {
    data_survival$Gen_eggs_extinct[data_survival$Population==i]<-
      min(data$Generation_Eggs[data$Population==i&data$First_Throw=="extinct"])
    data_survival$Survival[data_survival$Population==i] <- "extinct"
  }else{
    print(i)
  }
}


  str(data_survival)
data_survival$Survival <- as.factor(data_survival$Survival)
#Note: the Surv() function in the {survival} package accepts by default TRUE/FALSE, where TRUE is event and FALSE is censored; 1/0 where 1 is event and 0 is censored; or 2/1 where 2 is event and 1 is censored. Please take care to ensure the event indicator is properly formatted.
data_survival$status <- ifelse(data_survival$Survival=="extinct", 1, 0)
  


```



# PLOT 
## Population size
```{r }
PLOT_Pop_size<-ggplot2::ggplot(data, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults,  
                                group = Population,
                                colour = Genetic_Diversity)) + 
  geom_point(position = position_dodge(0.4), size = 0.8, alpha = 0.7) +
  geom_line(position = position_dodge(0.4), size = 0.2, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size


SUM_Popsize <- Rmisc::summarySE(data, 
                        measurevar = c("Nb_adults"),
                       groupvars = c("Generation_Eggs",
                                     "Genetic_Diversity"), 
                       na.rm=TRUE)
SUM_Popsize

# SUM_Popsize <- Rmisc::summarySE(data[data$Extinction_finalstatus=="no",],
#                         measurevar = c("Nb_adults"),
#                        groupvars = c("Generation_Eggs",
#                                      "Genetic_Diversity"),
#                        na.rm=TRUE)
# SUM_Popsize



PLOT_Pop_size_average <- PLOT_Pop_size + 
  geom_point(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 5, position = position_dodge(0.4)) +
  geom_errorbar(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                ymin = Nb_adults-ci, ymax = Nb_adults+ci, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 1, width=.2,  position = position_dodge(0.4)) +
  geom_line(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
           linetype = "dashed", size = 1.5, position = position_dodge(0.4)) 
PLOT_Pop_size_average
# cowplot::save_plot(file = here::here("figures","PopulationSize_average.pdf"),   PLOT_Pop_size_average, base_height = 10/cm(1),           base_width = 15/cm(1), dpi = 610)






#Prediction with models 
# Test effect

# data$gen_square <- data$Generation_Eggs^2
mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity +
                      gen_square*Genetic_Diversity + 
                Block  + (1|obs), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], 
            family = "poisson")



#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(2,6, length = 100),each=3),
                       Block = "Block4",
                       gen_square = (rep(seq(2,6, length = 100),each=3))^2,
                       Estimates = NA)

filldata$Estimates <- predict(mod1, newdata=filldata, type = "response", re.form=~0)


#Predcit estimate minimun values 
tapply(filldata$Estimates, filldata$Genetic_Diversity, min)

filldata[filldata$Estimates>=44.16&filldata$Estimates<=44.17,]
filldata[filldata$Estimates>=51.99&filldata$Estimates<=52.00,]
filldata[filldata$Estimates>=85.85&filldata$Estimates<=85.86,]


## Change name vector 
vector_names <- c(`Low` = "Strong bottleneck",
                    `Medium` = "Intermediate bottleneck",
                    `High` = "Diverse")


PLOT_Pop_size_predict<-ggplot2::ggplot(data[data$Extinction_finalstatus=="no",], 
                               aes(x = factor(Generation_Eggs), 
                                y = Nb_adults)) + 
  geom_point(aes(group = Population,
                 colour = Genetic_Diversity), 
             position = position_dodge(0.4), size = 0.7, alpha = 0.5) +
  geom_line(aes(group = Population,
                colour = Genetic_Diversity), 
            position = position_dodge(0.4), size = 0.05, alpha = 0.5) +
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.4) + 
  scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07", "#E7B800")) +
  ylab("Population size") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size_predict
# 
# cowplot::save_plot(file = here::here("figures","PopulationSize_predict.pdf"),   PLOT_Pop_size_predict, base_height = 10/cm(1),           base_width = 15/cm(1), dpi = 610)
# 
# 

``` 




## Extinction
```{r }
#Percent of extinction
length(unique(data$Population[data$Genetic_Diversity=="Low"&
                                data$Extinction_finalstatus=="yes"]))/
  length(unique(data$Population[data$Genetic_Diversity=="Low"]))

length(unique(data$Population[data$Genetic_Diversity=="Medium"&
                                data$Extinction_finalstatus=="yes"]))/
length(unique(data$Population[data$Genetic_Diversity=="Medium"]))
 
length(unique(data$Population[data$Genetic_Diversity=="High"&
                                data$Extinction_finalstatus=="yes"]))/
  length(unique(data$Population[data$Genetic_Diversity=="High"]))

#Create data with percent
vector_names <- c(`Low` = "Strong bottleneck",
                    `Medium` = "Intermediate bottleneck",
                    `High` = "Diverse")
f_labels = data.frame(Genetic_Diversity = c("High","Medium","Low"), 
                       label = c("Extinction = 0 %", "Extinction = 21.7 %", "Extinction = 23.5 %"))
f_labels$Genetic_Diversity <- factor(f_labels$Genetic_Diversity, 
                                     levels = c("High", "Medium", "Low"))






## Extinction yes no
PLOT_Extinction<-ggplot2::ggplot(data,  aes(x = factor(Generation_Eggs), 
                                y = Nb_adults)) + 
  facet_wrap(~ Genetic_Diversity, ncol=3, labeller = ggplot2::as_labeller(vector_names)) + 
  #geom_point(position = position_dodge(0.4), size = 0.4, alpha = 0.7) +
  geom_line(aes(group = Population,
                colour = Extinction_finalstatus), 
            position = position_dodge(0.1), size = 0.4, alpha = 0.8) +
  geom_text(x = 5, y = 420, 
            aes(label = label), 
            data = f_labels, 
            col="red", 
            size = 3, 
            vjust = 0) +
  scale_color_manual(values = c("black", "red")) +
  ylab("Population size") +
  xlab("Generation") +
  theme(legend.position = "none") +
  theme_LO
PLOT_Extinction
# 
# 
# cowplot::save_plot(here::here("figures","Extinction.pdf"),   PLOT_Extinction, base_height = 8/cm(1),
#           base_width = 20/cm(1), dpi = 610)
# #
# 



PLOT_Extinction 

    
``` 



## Growth rate G2
```{r }
tapply(data[data$Generation_Eggs==2,]$Lambda,data[data$Generation_Eggs==2,]$Genetic_Diversity,mean)

PLOT_Growth<-ggplot2::ggplot(data[data$Generation_Eggs==2,], aes(x = Genetic_Diversity, y = Lambda, 
                         colour = Genetic_Diversity)) + 
  geom_boxplot(aes(group = Genetic_Diversity),outlier.colour = NA) +
  geom_jitter(width = 0.25, size = 1, alpha = 0.8) +
  ylab("Growth rate") +
  theme(legend.position = "none") +
  xlab("Genetic diversity") +
  theme_LO
PLOT_Growth
# 
# cowplot::save_plot(here::here("figures","OldPlot_Growth_Start.pdf"),   PLOT_Growth, base_height = 10/cm(1),
#           base_width = 8/cm(1), dpi = 610)



``` 




## Life stage proportion
```{r }


SUM_Prop_adults<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_adults"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_adults

SUM_Prop_pupae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_pupae"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_pupae

SUM_Prop_larvae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_larvae"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_larvae

SUM_Prop <- data.frame(SUM_Prop_adults[,1:4],
                       p_pupae=SUM_Prop_pupae$p_pupae,
                       p_larvae=SUM_Prop_larvae$p_larvae)


SUM_Prop<-tidyr::gather(SUM_Prop,"Stage", "Proportion",4:6,-"Genetic_Diversity")
SUM_Prop
SUM_Prop$Stage <- factor(SUM_Prop$Stage, levels = c("p_adults", "p_pupae", "p_larvae"))



# New facet label names for supp variable
supp.weeks <- c("4 week", "5 week")
names(supp.weeks) <- c("4-week", "5-week")



PLOT_prop <- ggplot2::ggplot(data = SUM_Prop, aes(x = Genetic_Diversity, 
                                                  y = Proportion, fill = Stage)) +
  facet_wrap(~ Week, ncol=2, 
             labeller = labeller(Week = supp.weeks)) +
  geom_bar(stat="identity") + 
  xlab("Genetic history") +
  labs(color="Stage of individuals") +
  ylab("Proportion of each stage") +
  scale_fill_manual(values= c("#619CFF","#F8766D","#00BA38"), 
                    breaks = c("p_adults", "p_pupae", "p_larvae"),
                    labels = c( "Adult", "Pupae","Larvae")) + 
  ggplot2::scale_x_discrete(breaks=c("High", "Medium", "Low"), 
                            labels=c("Diverse", 
                                     "Intermediate\nbottleneck", 
                                      "Strong \nbottleneck")) + 
  theme_LO + 
  theme(strip.background = element_rect(color="grey30", 
                                        fill="white", size=0.5, linetype="solid"), 
        strip.text.x = element_text(size = 12, color = "black", face = "bold"))
PLOT_prop

# 
# cowplot::save_plot(here::here("figures","Life_stage_proportion.pdf"),   PLOT_prop,
#           base_height = 10/cm(1), base_width = 18/cm(1), dpi = 610)


``` 


## Growth rate and He
```{r }

# Remove pseudoreplication: average of each population
SUM_POP_He_Mean<- Rmisc::summarySE(data_phenotyping,
                            measurevar = c("Lambda"),
                            groupvars = c("Genetic_Diversity",
                                          "He_end",
                                          "Population"), 
                            na.rm=TRUE)


PLOT_He_Final <- ggplot2::ggplot(SUM_POP_He_Mean, aes(x = He_end,
                                                      y = Lambda, 
                                                      colour = Genetic_Diversity, 
                                                      size = N)) + 
    geom_point(alpha = 0.8) +
    ylab("Growth rate") +
    xlab("Expected heterozygosity") +
    scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07","#E7B800")) +
    labs(size="Replicates") + 
    theme_LO 
PLOT_He_Final
# 
# 
# cowplot::save_plot(here::here("figures","Heterozygosity_Growthrate.pdf"),
#                    PLOT_He_Final,
#           base_height = 12/cm(1), base_width = 16/cm(1), dpi = 610)
# 
# 



# # ALL WITHOUT PSEUDO
# SUM_POP_He_ALL<- Rmisc::summarySE(data_evolution_Lambda,
#                             measurevar = c("Lambda"),
#                        groupvars = c("Genetic_Diversity","Phenotyping", "He_remain", "He_end",
#                                      "Population"), 
#                        na.rm=TRUE)
# 
# SUM_POP_He_ALL$HE <- ifelse(SUM_POP_He_ALL$Phenotyping=="Initial",SUM_POP_He_ALL$He_remain,SUM_POP_He_ALL$He_end)
# 
# SUM_POP_He_ALL <- SUM_POP_He_ALL[!is.na(SUM_POP_He_ALL$He_end),]
# SUM_POP_He_ALL <- SUM_POP_He_ALL[SUM_POP_He_ALL$HE!="-Inf",]
# 
# 
# facet_names <- c('Initial'="Before rescue experiment",'Final'="After rescue experiment")
# 
# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda, 
#                          colour = Genetic_Diversity, 
#                          shape = Phenotyping)) +
#   #facet_wrap(~ Phenotyping, ncol=1) +
#   geom_point(size = 3, alpha = 0.8) +
#   scale_shape_manual(values = c(1, 19)) + 
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO 
# PLOT_He_ALL
# 
# 
# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda, 
#                          colour = Genetic_Diversity, 
#                          shape = Phenotyping)) +
#   facet_wrap(~ Phenotyping, ncol=1) +
#   geom_point(size = 3, alpha = 0.8) +
#   scale_shape_manual(values = c(1, 19)) + 
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO
# PLOT_He_ALL
# 
# 
# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda,
#                          colour = Genetic_Diversity)) +
#   facet_wrap(~ Phenotyping, ncol=1) +
#   geom_point(size = 3, alpha = 0.8) +
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO
# PLOT_He_ALL


``` 




## Lifestage and He
```{r }

SUM_Prop_adults<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_adults"),
                       groupvars = c("Genetic_Diversity","Week", "Population", "He_end"), 
                       na.rm = TRUE)
colnames(SUM_Prop_adults)[6]<-"prop" 
SUM_Prop_adults$lifestage <- "adults" 


SUM_Prop_pupae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_pupae"),
                       groupvars = c("Genetic_Diversity","Week", "Population", "He_end"), 
                       na.rm = TRUE)
colnames(SUM_Prop_pupae)[6]<-"prop" 
SUM_Prop_pupae$lifestage <- "pupae" 

SUM_Prop_larvae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_larvae"),
                       groupvars = c("Genetic_Diversity","Week", 
                                     "Population", "He_end"), 
                       na.rm = TRUE)
colnames(SUM_Prop_larvae)[6]<-"prop" 
SUM_Prop_larvae$lifestage <- "larvae" 


SUM_Prop_POP <- rbind(SUM_Prop_adults, SUM_Prop_pupae, SUM_Prop_larvae)



PLOT_Proportion_lifestage <- ggplot2::ggplot(SUM_Prop_POP, aes(x = He_end,
                                                      y = prop, 
                                                      colour = Genetic_Diversity, 
                                                      size = N)) + 
    facet_grid( Week ~ factor(lifestage, levels=c('larvae','pupae','adults'))) +
    geom_point(alpha = 0.8) +
    ylab("Proportion") +
    xlab("Expected heterozygosity") +
    scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07", "#E7B800")) + 
    labs(size="Replicates") + 
    theme_LO 
PLOT_Proportion_lifestage


 # 
 # cowplot::save_plot(here::here("figures","Life_stage_proportion_He.pdf"),
 #            PLOT_Proportion_lifestage,
 #           base_height = 14/cm(1), base_width = 36/cm(1), dpi = 610)
 # 

# 
``` 




## He over time 
```{r }

#Compute for all the other genrations, except the first one 
data$ID_extinction <- "extant"

for(i in unique(data$Population[data$Extinction_finalstatus=="yes"])){
    gen_all <- data$Generation_Eggs[data$Population==i&!is.na(data$He_remain)]
    maxgen <- max(gen_all)
    data$ID_extinction[data$Population==i&data$Generation_Eggs==maxgen] <- "willextinct" 
}

data[data$ID_extinction=="willextinct",]
dim(data[data$ID_extinction=="willextinct",])
data[data$ID_extinction=="willextinct","Population"]

data$Population[data$Genetic_Diversity=="Medium"&data$Extinction_finalstatus=="yes"]
  

PLOT_He_extinction <-ggplot2::ggplot(data, aes(x = factor(Generation_Eggs), 
                                y = He_remain, 
                                group = Population,
                                colour = Extinction_finalstatus, 
                                shape = ID_extinction)) + 
  geom_line(position = position_dodge(0.5), 
            size = 0.25, alpha = 0.6) +
  geom_point(position = position_dodge(0.5), size = 3,  stroke = 0.6,
             fill= "white", alpha = 0.8) +
  ylab("Expected heterozygozity") +
  scale_color_manual(values = c("black", "red")) +
  scale_shape_manual(values = c(21, 13), guide=FALSE) +
  labs(color="Extinct populations") +
  xlab("Generation") +
  theme_LO
PLOT_He_extinction
# # 
# cowplot::save_plot(here::here("figures","Heterozygosity_over_time.pdf"),
#                    PLOT_He_extinction,
#           base_height = 12/cm(1), base_width = 14/cm(1), dpi = 610)
# 


``` 

## Survival vs He 
```{r }

s2 <- survfit(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival)
summary(s2)

# Create a summary dataset 
SUM_survprob <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity), each =6), 
                       Generation_Eggs = rep(seq(1:6), n=3),
                       SurvProb = 1, 
                       se = 0)


SUM_survprob$SurvProb[SUM_survprob$Genetic_Diversity=="Medium"&
                        SUM_survprob$Generation_Eggs==4]<-summary(s2)$surv[1]
SUM_survprob$SurvProb[SUM_survprob$Genetic_Diversity=="Medium"&
                        SUM_survprob$Generation_Eggs==5]<-summary(s2)$surv[2]
SUM_survprob$SurvProb[SUM_survprob$Genetic_Diversity=="Medium"&
                        SUM_survprob$Generation_Eggs==6]<-summary(s2)$surv[3]

SUM_survprob$SurvProb[SUM_survprob$Genetic_Diversity=="Low"&
                        SUM_survprob$Generation_Eggs==4]<-summary(s2)$surv[4]
SUM_survprob$SurvProb[SUM_survprob$Genetic_Diversity=="Low"&
                        SUM_survprob$Generation_Eggs==5]<-summary(s2)$surv[5]
SUM_survprob$SurvProb[SUM_survprob$Genetic_Diversity=="Low"&
                        SUM_survprob$Generation_Eggs==6]<-summary(s2)$surv[6]
  
SUM_survprob$se[SUM_survprob$Genetic_Diversity=="Medium"&
                        SUM_survprob$Generation_Eggs==4]<-summary(s2)$std.err[1]
SUM_survprob$se[SUM_survprob$Genetic_Diversity=="Medium"&
                        SUM_survprob$Generation_Eggs==5]<-summary(s2)$std.err[2]
SUM_survprob$se[SUM_survprob$Genetic_Diversity=="Medium"&
                        SUM_survprob$Generation_Eggs==6]<-summary(s2)$std.err[3]

SUM_survprob$se[SUM_survprob$Genetic_Diversity=="Low"&
                        SUM_survprob$Generation_Eggs==4]<-summary(s2)$std.err[4]
SUM_survprob$se[SUM_survprob$Genetic_Diversity=="Low"&
                        SUM_survprob$Generation_Eggs==5]<-summary(s2)$std.err[5]
SUM_survprob$se[SUM_survprob$Genetic_Diversity=="Low"&
                        SUM_survprob$Generation_Eggs==6]<-summary(s2)$std.err[6]
  

data_survprob_he <- merge(x = data, y = SUM_survprob, by = c("Genetic_Diversity", "Generation_Eggs"), all.x=TRUE)
head(data_survprob_he)


Plot_survival <- ggplot2::ggplot(data_survprob_he, aes(x = He_remain,  y = SurvProb ,  colour = Genetic_Diversity)) + 
    geom_point(alpha = 0.8) +
    ylab("Survival probability") +
    xlab("Expected heterozygosity") +
    scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07", "#E7B800")) + 
    labs(size="Replicates") + 
    theme_LO 

# 
# 
# cowplot::save_plot(here::here("figures","Survival_function_He.pdf"),
#                    Plot_survival,
#           base_height = 12/cm(1), base_width = 14/cm(1), dpi = 610)
# 


```



# ANALYSIS 
## Probability of extinction
```{r }
############ 
###### Clean dataset
############ 
#Prepare clean dataset
data_proba_extinction <- data[data$Generation_Eggs==6,
                              c("Block","Population","Genetic_Diversity","Extinction_finalstatus")]
data_proba_extinction$Extinction_finalstatus <- as.factor(data_proba_extinction$Extinction_finalstatus)
data_proba_extinction$y <- ifelse(data_proba_extinction$Extinction_finalstatus == "yes", 1, 0)



############ 
###### Analysis
############ 
#Analysis
mod0 <- glm(y ~ Genetic_Diversity + Block,  
      data = data_proba_extinction, family = binomial)


summary(mod0)



#Test convergence 


#Test genetic diversity effect
mod1 <- glm(y ~ Block ,  
      data = data_proba_extinction, family = binomial)
anova(mod1, mod0, test = "Chisq")
#We keep genetic diversity 

# Perform the lrtest 
(A <- logLik(mod1))
(B <- logLik(mod0))
#Since the logLik() function gives more information than the numeric value, use the as.numeric() function to isolate the numeric value
(teststat <- -2 * (as.numeric(A)-as.numeric(B)))
#df = 5 - 3 = 2
(p.val <- pchisq(teststat, df = 2, lower.tail = FALSE))

lmtest::lrtest(mod1, mod0)



mod0 <- glm(y ~ Genetic_Diversity-1 + Block ,  
      data = data_proba_extinction, family = binomial)
summary(mod0)



############ 
###### Predicted value
############ 
#Extract probability of extinction 
(p_high <- plogis(-21.3144))
(p_med <- plogis(-3.0142))
(p_low <- plogis(-2.8082))

data_predict_extinct <- data.frame(Genetic_Diversity = levels(data_proba_extinction$Genetic_Diversity),
                                   Block = "Block4")

data_predict_extinct$predict <- predict(mod0, type = "response",
        re.form = NA,
        newdata = data_predict_extinct)
        
data_predict_extinct
p_high
p_med
p_low


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 





``` 



##  Time to extinction 
```{r }


data_timeextinction<-data[data$First_Throw=="extinct",]
data_timeextinction <- data_timeextinction[complete.cases(data_timeextinction$Nb_adults), ]
data_timeextinction

tapply(data_timeextinction$Generation_Eggs,data_timeextinction$Genetic_Diversity,mean)


#Test time of extinction
mod1 <- glm(Generation_Eggs ~ Genetic_Diversity + Block,
                    data = data_timeextinction, family = "poisson")
mod0 <- glm(Generation_Eggs ~  Block,
                    data = data_timeextinction, family = "poisson")

anova(mod0, mod1, test = "Chisq")
#We keep genetic diversity 

# Perform the lrtest 
(A <- logLik(mod1))
(B <- logLik(mod0))
#Since the logLik() function gives more information than the numeric value, use the as.numeric() function to isolate the numeric value
(teststat <- -2 * (as.numeric(A)-as.numeric(B)))
#df = 5 - 3 = 2
(p.val <- pchisq(teststat, df = 2, lower.tail = FALSE))

lmtest::lrtest(mod0,mod1)

``` 


## Survival analysis
```{r }
str(data_survival)
#Note: the Surv() function in the {survival} package accepts by default TRUE/FALSE, where TRUE is event and FALSE is censored; 1/0 where 1 is event and 0 is censored; or 2/1 where 2 is event and 1 is censored. Please take care to ensure the event indicator is properly formatted.
  

# The Surv() function from the {survival} package creates a survival object for use as the response in a model formula. There will be one entry for each subject that is the survival time, which is followed by a + if the subject was censored. Let’s look at the first 10 observations:
Surv(data_survival$Gen_eggs_extinct, data_survival$status)

#Surv(data_survival_all$Gen_eggs_extinct, data_survival$status)



# The survfit() function creates survival curves using the Kaplan-Meier method based on a formula. Let’s generate the overall survival curve for the entire cohort, assign it to object s1, and look at the structure using str():
s1 <- survfit(Surv(Gen_eggs_extinct, status) ~ 1, data = data_survival)
str(s1)
# time: the timepoints at which the curve has a step, i.e. at least one event occurred
# surv: the estimate of survival at the corresponding time


   
# The {ggsurvfit} package works best if you create the survfit object using the included ggsurvfit::survfit2() function, which uses the same syntax to what we saw previously with survival::survfit(). The ggsurvfit::survfit2() tracks the environment from the function call, which allows the plot to have better default values for labeling and p-value reporting.
# 

####
#### PLOT 
####
ggsurvfit::survfit2(Surv(Gen_eggs_extinct, status) ~ 1, data = data_survival) %>% 
  ggsurvfit() +
  ggplot2::labs( x = "Generation",
        y = "Overall survival probability") + 
  add_confidence_interval()  +
  add_risktable()

summary(survfit(Surv(Gen_eggs_extinct, status) ~ 1, data = data_survival))



##### COMPARISONS ACROSS GROUPS
# We can conduct between-group significance tests using a log-rank test. The log-rank test equally weights observations over the entire follow-up time and is the most common way to compare survival times between groups. There are versions that more heavily weight the early or late follow-up that could be more appropriate depending on the research question (see ?survdiff for different test options).
# 
# We get the log-rank p-value using the survdiff function. For example, we can test whether there was a difference in survival time according to the demography history in the lung data:
  
  

#Comparison 
survdiff(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival)

summary(survfit(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival))




####
#### PLOT 
####
plot_survival <- ggsurvfit::survfit2(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival) %>% 
  ggsurvfit(size = 2) +
  labs( x = "Generation",
        y = "Overall survival probability") + 
  add_confidence_interval(alpha = 0.1)  + 
  add_censor_mark(size = 8, shape = "x") +
  scale_fill_manual(name="Demographic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07", "#E7B800")) + 
  scale_color_manual(name="Demographic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07", "#E7B800"))  #+  add_risktable()
plot_survival


# cowplot::save_plot(file = here::here("figures","Extinction_Survival_analysis.pdf"),   
#                    plot_survival, base_height = 10/cm(1),  base_width = 15/cm(1), dpi = 610)


# COX representation 
coxph(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival)

coxph(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival) %>% 
  gtsummary::tbl_regression(exp = TRUE) 

# The quantity of interest from a Cox regression model is a hazard ratio (HR). The HR represents the ratio of hazards between two groups at any particular point in time. The HR is interpreted as the instantaneous rate of occurrence of the event of interest in those who are still at risk for the event. It is not a risk, though it is commonly mis-interpreted as such. If you have a regression parameter β, then HR = exp(β).
# 
# A HR < 1 indicates reduced hazard of death whereas a HR > 1 indicates an increased hazard of death.
# 
# So the HR = 0.59 implies that 0.59 times as many females are dying as males, at any given time. Stated differently, females have a significantly lower hazard of death than males in these data.







### OTHER REPRESENTATION :  
s2 <- survfit(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival)
summary(s2)
print(s2)
# Access to the sort summary table
summary(s2)$table

d <- data.frame(time = s2$time,
                  n.risk = s2$n.risk,
                  n.event = s2$n.event,
                  n.censor = s2$n.censor,
                  surv = s2$surv,
                  upper = s2$upper,
                  lower = s2$lower)
head(d)


plot2 <- survminer::ggsurvplot(s2,
                               pval = TRUE,             # show p-value of log-rank test.
                               #pval.coord  = c(1,0.2), 
                               pval.size = 5, 
                               conf.int = TRUE,         # show confidence intervals for point estimaes of survival curves.
                               # conf.int.style = "step",  # customize style of confidence intervals
                               conf.int.style = "ribbon",  # customize style of confidence intervals 
                               conf.int.alpha = 0.3,  # customize style of confidence intervals
                               censor = TRUE, 
                               censor.shape = "x", 
                               censor.size = 6, 
                               xlab = "Generation",   # customize X axis label.
                               break.time.by = 1,     # break X axis in time intervals by 1
                               ggtheme = theme_light(), # customize plot and risk table with a theme.
                              #risk.table = TRUE, # Add risk table
                              #linetype = "strata", # Change line type by groups
                               risk.table = "abs_pct",  # absolute number and percentage at risk.
                               risk.table.y.text.col = T,# colour risk table text annotations.
                               risk.table.y.text = FALSE,# show bars instead of names in text annotations in legend of risk table.
                               risk.table.col = "strata", # Change risk table color by groups
                               legend.labs = c("Diverse","Intermediate bottleneck","Strong bottleneck"),   
                               legend = c("right"),
                              legend.title = c("Demographic\nhistory:"),   
                               palette = c("#00AFBB", "#E7B800", "#FC4E07")) 



plot2
# 
# cowplot::save_plot(file = here::here("figures","Extinction_Survival_analysis_V2.pdf"),
#                    plot2, base_height = 10/cm(1),  base_width = 15/cm(1), dpi = 610)



# Fit a Cox proportional hazards model
# fit.coxph <- coxph(Surv(Gen_eggs_extinct, status) ~ Genetic_Diversity, data = data_survival)
# ggforest(fit.coxph, data = data_survival)



``` 



## Population size over time
### Polynomial analysis 
#### Prelim: test function
```{r }


####################### 
####################### MODEL INCLUDING GENETIC DIVERSITY WITHOUT GEN 1  
####################### 
###################### REMOVE GEN 1 ##########################33

#If we dont consider Gen=1 
PLOT_Pop_size_average
fit <- lm(log(Nb_adults+1) ~ Generation_Eggs, data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])
#second degree
fit2 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,2,raw=TRUE), 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])
#third degree
fit3 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,3,raw=TRUE), 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])
#fourth degree
fit4 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,4,raw=TRUE), 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])
#fourth degree
fit5 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,5,raw=TRUE), 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])
#exp
fit6 <- lm(log(Nb_adults+1)~exp(Generation_Eggs), 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])
#log
fit7 <- lm(log(Nb_adults+1)~log(Generation_Eggs), 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",])

fit <- glm(Nb_adults ~ Generation_Eggs, 
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit3 <- glm(Nb_adults~stats::poly(Generation_Eggs,3,raw=TRUE), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit5 <- glm(Nb_adults~stats::poly(Generation_Eggs,5,raw=TRUE), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit6 <- glm(Nb_adults~exp(Generation_Eggs), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit7 <- glm(Nb_adults~log(Generation_Eggs), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")





#generate range of 50 numbers starting from 30 and ending at 160
# xx <- seq(1,6, length=100)
# plot(data[data$Generation_Eggs>=2,]$Generation_Eggs,
#      log(data[data$Generation_Eggs>=2,]$Nb_adults+1),pch=19,ylim=c(0,8))
# lines(xx, predict(fit, data.frame(Generation_Eggs=xx)), col="red")
# lines(xx, predict(fit2, data.frame(Generation_Eggs=xx)), col="green")
# lines(xx, predict(fit3, data.frame(Generation_Eggs=xx)), col="blue")
# lines(xx, predict(fit4, data.frame(Generation_Eggs=xx)), col="purple")
# lines(xx, predict(fit5, data.frame(Generation_Eggs=xx)), col="yellow")
# lines(xx, predict(fit6, data.frame(Generation_Eggs=xx)), col="orange")
# lines(xx, predict(fit7, data.frame(Generation_Eggs=xx)), col="pink")
xx <- seq(1,6, length=100)
plot(data[data$Generation_Eggs>=2,]$Generation_Eggs,
     data[data$Generation_Eggs>=2,]$Nb_adults,pch=19)
lines(xx, predict(fit, data.frame(Generation_Eggs=xx),type = "response"), col="red")
lines(xx, predict(fit2, data.frame(Generation_Eggs=xx),type = "response"), col="green")
lines(xx, predict(fit3, data.frame(Generation_Eggs=xx),type = "response"), col="blue")
lines(xx, predict(fit4, data.frame(Generation_Eggs=xx),type = "response"), col="purple")
lines(xx, predict(fit5, data.frame(Generation_Eggs=xx),type = "response"), col="yellow")
lines(xx, predict(fit6, data.frame(Generation_Eggs=xx),type = "response"), col="orange")
lines(xx, predict(fit7, data.frame(Generation_Eggs=xx),type = "response"), col="pink")


# Check the r squared
rsq::rsq(fit,adj=TRUE)
rsq::rsq(fit2,adj=TRUE)
rsq::rsq(fit3,adj=TRUE)
rsq::rsq(fit4,adj=TRUE)
rsq::rsq(fit5,adj=TRUE)
rsq::rsq(fit6,adj=TRUE)
rsq::rsq(fit7,adj=TRUE)

# Best model is fit 2

#data$gen_square <- data$Generation_Eggs^2
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
fit2 <- glm(Nb_adults~Generation_Eggs + gen_square, 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")

# fit2 <- lm(log(Nb_adults+1)~poly(Generation_Eggs,2,raw=TRUE), data = data[data$Generation_Eggs>=2,])
# fit2 <- lm(log(Nb_adults+1)~ Generation_Eggs + gen_square, data = data[data$Generation_Eggs>=2,])
#Add the interaction with Genetic diversity
fit2 <- glm(Nb_adults~ Generation_Eggs*Genetic_Diversity +
             gen_square*Genetic_Diversity,
           data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], 
           family = "poisson")


summary(fit2)

####### Next step: Final step: add genetic diversity 

``` 


#### Analysis
```{r }
#Test oversdispersion
mod0 <- glm(Nb_adults~Generation_Eggs*Genetic_Diversity + 
              gen_square*Genetic_Diversity + 
              Block , 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], 
            family = "poisson")
sqrt(deviance(mod0)/(nobs(mod0)-length(coef(mod0))))
sigma(mod0)
# ccl: overdispersion


mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs) , 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], 
            family = "poisson")
blmeco::dispersion_glmer(mod1)
sigma(mod1)

#Convergence issue 
max(abs(with(mod1@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001



mod1

#Test add Population random
mod0 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs) + (1|Population), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], 
            family = "poisson")

max(abs(with(mod0@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001
max(abs(with(mod1@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001
anova(mod0, mod1, test ="Chisq")  




########## LRT and Final model: 
mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs)  + (1|Population), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
mod2 <- lme4::glmer(Nb_adults~Generation_Eggs + gen_square + Genetic_Diversity + 
                Block  + (1|obs)  + (1|Population), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
anova(mod1, mod2, test ="Chisq")  



#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(2,6, length = 100),each=3),
                       Block = "Block4",
                       gen_square = (rep(seq(2,6, length = 100),each=3))^2,
                       Estimates = NA)

filldata$Estimates <- predict(mod1, newdata=filldata, type = "response", re.form=~0)


#Plot
PLOT_Pop_size <- ggplot2::ggplot(data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",]) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.3) +
  geom_point(data = data, 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size

emmeans::emmeans(mod1, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 



``` 


#### Extra: with gen1
```{r }


###################################################################
###################################################################
###################################################################
###################################################################
####################  EXTRA: INCLUDING GEN 1 ###########################
PLOT_Pop_size_average
fit <- glm(Nb_adults ~ Generation_Eggs, data = data, family = "poisson")
#second degree
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), data = data, family = "poisson")
#third degree
fit3 <- glm(Nb_adults~stats::poly(Generation_Eggs,3,raw=TRUE), data = data, family = "poisson")
#fourth degree
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), data = data, family = "poisson")
#fourth degree
fit5 <- glm(Nb_adults~stats::poly(Generation_Eggs,5,raw=TRUE), data = data, family = "poisson")
#exp
fit6 <- glm(Nb_adults~exp(Generation_Eggs), data = data, family = "poisson")
#log
fit7 <- glm(Nb_adults~log(Generation_Eggs), data = data, family = "poisson")


#generate range of 50 numbers starting from 30 and ending at 160
xx <- seq(1,6, length=100)
plot(data$Generation_Eggs,
     data$Nb_adults,pch=19)
lines(xx, predict(fit, data.frame(Generation_Eggs=xx),type = "response"), col="red")
lines(xx, predict(fit2, data.frame(Generation_Eggs=xx),type = "response"), col="green")
lines(xx, predict(fit3, data.frame(Generation_Eggs=xx),type = "response"), col="blue")
lines(xx, predict(fit4, data.frame(Generation_Eggs=xx),type = "response"), col="purple")
lines(xx, predict(fit5, data.frame(Generation_Eggs=xx),type = "response"), col="yellow")
lines(xx, predict(fit6, data.frame(Generation_Eggs=xx),type = "response"), col="orange")
lines(xx, predict(fit7, data.frame(Generation_Eggs=xx),type = "response"), col="pink")

# Check the r squared
summary(fit)$adj.r.squared
summary(fit2)$adj.r.squared
summary(fit3)$adj.r.squared
summary(fit4)$adj.r.squared # best r square
summary(fit5)$adj.r.squared 
summary(fit6)$adj.r.squared 
summary(fit7)$adj.r.squared 

rsq::rsq(fit,adj=TRUE)
rsq::rsq(fit2,adj=TRUE)
rsq::rsq(fit3,adj=TRUE)
rsq::rsq(fit4,adj=TRUE)
rsq::rsq(fit5,adj=TRUE)
rsq::rsq(fit6,adj=TRUE)
rsq::rsq(fit7,adj=TRUE)



#
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), data = data, family = "poisson")


####################### 
####################### MODEL INCLUDING GENETIC DIVERSITY and GEN 1 
####################### 

#Test oversdispersion
fit4 <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + (1|Block), data = data, family = "poisson")
blmeco::dispersion_glmer(fit4)

mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
blmeco::dispersion_glmer(mod)


#Convergence issue 
max(abs(with(mod@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001

#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(1,6, length = 100),each=3),
                       Block = "Block4", 
                       Estimates = NA)
filldata$Estimates <- predict(fit4, newdata=filldata, type = "response")


#Plot
PLOT_Pop_size <- ggplot2::ggplot(data = data) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.3) +
  geom_point(data = data, 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size




# fit2 <- lm(log(Nb_adults+1)~ Generation_Eggs*Genetic_Diversity + 
#              gen_square*Genetic_Diversity, 
#            data = data[data$Generation_Eggs>=2,])
# fit2_test <- lm(log(Nb_adults+1)~ Generation_Eggs+Genetic_Diversity + 
#              gen_square, 
#            data = data[data$Generation_Eggs>=2,])

mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
mod1 <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)+Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
anova(mod,mod1, test = "Chisq")
#Signifcant interaction 
summary(mod)
summary(mod1)


emmeans::emmeans(mod, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 





####################### 
####################### MODEL INCLUDING ONLY RESCUED POPULATIONS
####################### 
#Same but only for population not extinct
fit_fin <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity,
            data = data[data$Extinction_finalstatus=="no",], family = "poisson")

filldata$Estimates_Withoutextpop <- predict(fit_fin, newdata=filldata, type = "response")

PLOT_Pop_size <- ggplot2::ggplot(data = data) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates_Withoutextpop, 
                               colour = Genetic_Diversity), size = 1.5, linetype = "longdash") +
  geom_point(data = data[data$Extinction_finalstatus=="no",], 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.5) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size




mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), 
             data = data[data$Extinction_finalstatus=="no",], family = "poisson")
mod1 <- lme4::glmer(Nb_adults~poly(Generation_Eggs,4,raw=TRUE)+Genetic_Diversity + 
               (1|Block) + (1|obs), 
              data = data[data$Extinction_finalstatus=="no",], family = "poisson")
anova(mod,mod1, test = "Chisq")


summary(mod)

emmeans::emmeans(mod, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 

``` 


#### Extra: Pop. size G6
```{r }

############ 
###### Analysis
############ 
#Analysis
# mod0 <- lme4::glmer(Nb_adults ~ Genetic_Diversity + Block + (1|Population),  
#       data = data[data$Generation_Eggs==6,], family = "poisson")


mod0 <- lm(log(Nb_adults) ~ Genetic_Diversity + Block, 
             data = data[data$Generation_Eggs==6&data$Extinction_finalstatus == "no",])

mod1 <- lm(log(Nb_adults) ~ Block , 
             data = data[data$Generation_Eggs==6&data$Extinction_finalstatus == "no",])

anova(mod0, mod1) # Effect of genetic diversity 

mod0 <- lm(log(Nb_adults) ~ Genetic_Diversity + Block, 
             data = data[data$Generation_Eggs==6&data$Extinction_finalstatus == "no",])


summary(mod0)


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 

``` 

### GAMMM Model
#### Basic model
```{r }
# https://jacolienvanrij.com/Tutorials/GAMM.html
# install.packages("itsadug")
# packageVersion('mgcv')
# packageVersion('itsadug')

data_dyn <- data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",]
str(data_dyn)

# 1-dimensional smooth of Time:
#m1 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs), data=data_dyn)
#Meaning the GAM has failed to construct a sensible smooth term for this data. You can limit the maximum df of the smooth using the k parameter:
m1 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, k=3), data=data_dyn)

#number of ‘knots’. This parameter determines the upper bound of the number of underlying base functions being used to build up the curve. Thus, this parameter constraints the wigglyness of a smooth, or - as a metaphor - the number of bowpoints of a curve.
#Note that the model will base the number of base functions (reflected in the edf of the summary) on the data with the setting for k as upper bound. By default, the value of k for s() is around 9, and for te() and ti() 5 per dimension. Importantly, the value of k should be at most one less than the number of unique data points, otherwise it will fit the density of that predictor.

# interaction with non-isotropicterms:
#m2 <- gam(Nb_adults ~ te(Generation_Eggs, Genetic_Diversity), data=data_dyn)

# decompose the same interaction in main effects + interaction:
# (note: include main effects)
# m3 <- gam(Nb_adults ~ s(Generation_Eggs) + s(Genetic_Diversity) +
#           + ti(Generation_Eggs, Genetic_Diversity), 
#           data=data_dyn)

# s() : for modeling a 1-dimensional smooth, or for modeling isotropic interactions (variables are measured in same units and on same scale)
# te(): for modeling 2- or n-dimensional interaction surfaces of variables that are not isotropic (but see info about d parameter below). Includes ‘main’ effects.
# ti(): for modeling 2- or n-dimensional interaction surfaces that do not include the ‘main effects

########### 
########### ADD FACTOR EFFECT: 
########### 

# How to set up the interaction depends on the type of grouping predictor:
# with factor include intercept difference: Group + s(Time, by=Group).
# with ordered factor include intercept difference and reference smooth: Group + s(Time) + s(Time, by=Group).
# with binary predictor include reference smooth: s(Time) + s(Time, by=IsGroupChildren).

m.factor <- mgcv::gam(Nb_adults ~ Genetic_Diversity +  s(Generation_Eggs, k=3) + 
            s(Generation_Eggs, by= Genetic_Diversity, k=3), data=data_dyn)
summary(m.factor)

#The smooth terms summary shows three smooths that are significantly different from 0. 
#We cannot conclude from the summary that the two curves are different from each other.


m.factor <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=3) + 
            s(Generation_Eggs, by= Genetic_Diversity, k=3), data=data_dyn)
summary(m.factor)

########### 
########### ADD RANDOM EFFECT: 
########### 

# random intercepts adjust the height of other modelterms with a constant value: s(Subject, bs="re").
# random slopes adjust the slope ofthe trend of a numeric predictor: s(Subject, Time, bs="re").
# random smooths adjust the trend of a numeric predictor in a nonlinear way: s(Time, Subject, bs="fs", m=1).

m.mixed <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block + s(Generation_Eggs, k=3) + 
            s(Generation_Eggs, by= Genetic_Diversity, k=3) + 
             s(Population, bs="re") , data=data_dyn)
summary(m.mixed)




```


#### Model selection
```{r }
########### 
########### AIC
########### 
m1 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, by= Genetic_Diversity, k=3), data=data_dyn)
m2 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, by= Genetic_Diversity, k=4), data=data_dyn)
m3 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, by= Genetic_Diversity, k=5), data=data_dyn)
m4 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=3), data=data_dyn)
m5 <- mgcv::gam(Nb_adults ~ Block+ 
                  s(Generation_Eggs, by= Genetic_Diversity, k=4), data=data_dyn)
m6 <- mgcv::gam(Nb_adults ~ Block +  s(Generation_Eggs, k=3) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5), data=data_dyn)
m7 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=3) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5), data=data_dyn)
m8 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, by= Genetic_Diversity, k=3) + 
                   s(Population, bs="re"), data=data_dyn)
m9 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, by= Genetic_Diversity, k=4) + 
                   s(Population, bs="re"), data=data_dyn)
m10 <- mgcv::gam(Nb_adults ~ s(Generation_Eggs, by= Genetic_Diversity, k=5)+
                  s(Population, bs="re"),data=data_dyn)
m11 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=3)+
                    s(Population, bs="re"), data=data_dyn)
m12 <- mgcv::gam(Nb_adults ~ Block +  
                  s(Generation_Eggs, by= Genetic_Diversity, k=4) + 
                    s(Population, bs="re"), data=data_dyn)
m13 <- mgcv::gam(Nb_adults ~ Block +  s(Generation_Eggs, k=3) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
m14 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=3) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
m15 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=5) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
m16 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=4) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=4) + 
                    s(Population, bs="re"), data=data_dyn)
m17 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=3) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=3) + 
                    s(Population, bs="re"), data=data_dyn)

AIC(m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12,m13,m14,m15,m16,m17)



#https://www.seascapemodels.org/rstats/2021/03/27/common-GAM-problems.html




# Real comparison 
mod0 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=5) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
mod1 <- mgcv::gam(Nb_adults ~ Block +  s(Generation_Eggs, k=5) + 
                  s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
mod2 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
mod3 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  
                    s(Generation_Eggs, by= Genetic_Diversity, k=3) + 
                    s(Population, bs="re"), data=data_dyn)
mod4 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  
                    s(Generation_Eggs, by= Genetic_Diversity, k=4) + 
                    s(Population, bs="re"), data=data_dyn)
mod5 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  
                    s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
mod7 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +   s(Generation_Eggs, k=3) +
                    s(Generation_Eggs, by= Genetic_Diversity, k=3) + 
                    s(Population, bs="re"), data=data_dyn)
mod8 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +   s(Generation_Eggs, k=4) +
                    s(Generation_Eggs, by= Genetic_Diversity, k=4) + 
                    s(Population, bs="re"), data=data_dyn)
mod9 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +   s(Generation_Eggs, k=5) +
                    s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)

AIC(mod1, mod2, mod3, mod4, mod5, mod7, mod8, mod9)




mod2 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +  s(Generation_Eggs, k=5) + 
                    s(Population, bs="re"), data=data_dyn)
mod9 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +   s(Generation_Eggs, k=5) +
                    s(Generation_Eggs, by= Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), data=data_dyn)


AIC(mod2, mod8, mod9)

visreg::visreg(mod9, xvar = "Generation_Eggs",
       by = "Genetic_Diversity", data = data_dyn,
       method = "REML")
visreg::visreg(mod2, xvar = "Generation_Eggs",
       by = "Genetic_Diversity", data = data_dyn,
       method = "REML")







```



#### Testing for significance
```{r }
# Three important methods to determine the significance of predictors:
## -1 Model-comparison procedure (using function compareML).
## -2 Test statistics of the smooth terms as presented in the summary.
## -3 Visualization of the smooth terms (e.g., difference plots and difference surfaces) but useful only with significative interaction https://jacolienvanrij.com/Tutorials/GAMM.html 


###### 1- Model comparison 

mod_1 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +   s(Generation_Eggs, k=5) +
                    s(Generation_Eggs, by = Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), method="ML", data=data_dyn)
mod_2 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block  +  s(Generation_Eggs, k=5) +
                    s(Population, bs="re"), data=data_dyn, method='ML')

itsadug::compareML(mod_1, mod_2)
AIC(mod_1, mod_2)



mod_2 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block  +  s(Generation_Eggs, k=5) +
                    s(Population, bs="re"), data=data_dyn, method='ML')
mod_3 <- mgcv::gam(Nb_adults ~ Block  +  s(Generation_Eggs, k=5) +
                    s(Population, bs="re"), data=data_dyn, method='ML')
itsadug::compareML(mod_3, mod_2)


mod_final <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block  +  
                         s(Generation_Eggs, k=5) +
                         s(Population, bs="re"), data=data_dyn, method='ML')

###### 2- Summary of the model
# With factors such as Group we cannot use the summary to test differences between groups. However, to investigate differences between groups, we could use difference smooths with ordered factors or binary predictors.
data_dyn$OFGroup_diversity <- as.factor(data_dyn$Genetic_Diversity)
# change factor to ordered factor:
data_dyn$OFGroup_diversity <- as.ordered(data_dyn$OFGroup)
# change contrast to treatment coding (difference curves)
contrasts(data_dyn$OFGroup_diversity) <- 'contr.treatment'
# Inspect contrasts:
contrasts(data_dyn$OFGroup_diversity)


mod_1 <- mgcv::gam(Nb_adults ~ OFGroup_diversity + Block +   s(Generation_Eggs, k=5) +
                    s(Generation_Eggs, by = OFGroup_diversity, k=5) + 
                    s(Population, bs="re"), method="ML", data=data_dyn)


summary(mod_1)
#We confirm: No interaction significative
# The summary now provides the significance of the difference terms: Medium and High does not show a significantly different trend over Time (F=0.130, edf=1.21, p=0.69), Low and High does not showa significantly different trend over Time (F=0.226, edf=1.001, p=0.02). 

mod_2 <- mgcv::gam(Nb_adults ~ OFGroup_diversity + Block +   s(Generation_Eggs, k=5) +
                    s(Population, bs="re"), method="ML", data=data_dyn)
summary(mod_2)

  
###### 2-  Visualization of the smooth terms
# seful only with significative interaction 
# Which is not the case here
# But see: https://jacolienvanrij.com/Tutorials/GAMM.html


```


#### Plot
```{r }

data_dyn <- data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",]

mod_final <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block + 
                     s(Generation_Eggs, k=5) +  
                     s(Population, bs="re"), data=data_dyn)


# Plot  block effect
mod_block_P <- tidymv::predict_gam(mod_final, 
                               exclude_terms = list("s(Population)"), 
                               values = list(Population = NULL))

ggplot(data = mod_block_P, aes(Generation_Eggs, fit)) +
    facet_wrap(~ Block) +
    tidymv::geom_smooth_ci(Genetic_Diversity)



# Plot Diversity effect
mod_A_p <- tidymv::predict_gam(mod_final, 
                               exclude_terms = list("s(Population)", "Block"), 
                               values = list(Population = NULL, Block = NULL))

ggplot(data = mod_A_p, aes(Generation_Eggs, fit)) +
   tidymv::geom_smooth_ci(Genetic_Diversity) 

 
## Prediction for main text 
#population size at the end
as.data.frame(mod_A_p[mod_A_p$Generation_Eggs==6,])

#minimum population size 
tempdata <- as.data.frame(mod_A_p)
tapply(mod_A_p$fit,mod_A_p$Genetic_Diversity,min)
tempdata[tempdata$Genetic_Diversity=="High"&tempdata$fit<=114,]

## PLOT

plot_GAM_Ucurve <- ggplot(data = mod_A_p, aes(Generation_Eggs, fit)) +
  geom_point(data = data[data$Extinction_finalstatus=="no",], 
             aes(x = Generation_Eggs,
                                y = Nb_adults,
                               group = Genetic_Diversity,
                               # group = Population,
                                colour = Genetic_Diversity),
             position = position_dodge2(0.3), 
             size = 0.6, alpha = 0.9) +
  tidymv::geom_smooth_ci(Genetic_Diversity, 
                 size = 1.5, linetype = 1)  + 
  ylab("Population size") +
  xlab("Generation") +
  scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"),
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"),
                   # values = c("#685338", "#FEA698", "#7BC7AD")) +
                   # values = c( "#51392C","#DA5837", "#4C9E97")) +
                   # values = c( "#00AFBB", "#E7B800", "#FC4E07")) +
  
                   #  values = c("#9AD3CA", "#929FD1", "#E7C7D7")) +
                   #values = c("#227C9D", "#FFCB77", "#FE6D73")) +
                     values = c("#00AFBB","#FC4E07","#E7B800")) +
 theme_LO 


plot_GAM_Ucurve
# 
# cowplot::save_plot(file = here::here("figures","PopulationSize_GAM.pdf"),
#                    plot_GAM_Ucurve, base_height = 10/cm(1),           
#                    base_width = 15/cm(1), dpi = 610)
# 

  


```


## Variance over time 
### Residuals residuals
```{r }
#data$gen_square <- data$Generation_Eggs^2
data_G2_all <- data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",]
data_G2_all <- data_G2_all[complete.cases(data_G2_all$Nb_adults), ]

Initial_model<- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs), 
            data = data_G2_all, 
            family = "poisson")
data_G2_all$resid <- resid(Initial_model)

PLOT_Pop_size_predict

#PLOT RESIDUALS

ggplot2::ggplot(data_G2_all, aes(x = factor(Generation_Eggs),  
                                 y = resid, 
                                 colour = Genetic_Diversity)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(position = position_dodge(0.75), size = 0.7, alpha = 0.5) +
  scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#E7B800","#FC4E07")) +
  ylab("Resid(pop size)") +
  xlab("Generation") +
  theme_LO

########### 
########### OPTION A: Test random effects 
########### 

# Test variances with residuals and random effects: 
model_withrandomeffect <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs) + (1|Genetic_Diversity:Generation_Eggs) , 
            data = data_G2_all, 
            family = "poisson")
model_withoutrandomeffect <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs) , 
            data = data_G2_all, 
            family = "poisson")

anova(model_withrandomeffect,model_withoutrandomeffect, test = "Chisq")
AIC(model_withrandomeffect)
AIC(model_withoutrandomeffect) 
#Best model: without random effects 

summary(model_withoutrandomeffect)

#Note: should be the same as: 
model_lm_withrandomeffects <- lme4::lmer(resid ~ (1|Genetic_Diversity:Generation_Eggs), data = data_G2_all)
lmerTest::rand(model_lm_withrandomeffects)

########### 
########### OPTION B: Test with Levene's test on residuals
########### 

# Test variances with Levene's test 
tapply(data_G2_all$resid, list(data_G2_all$Generation_Eggs, data_G2_all$Genetic_Diversity),var)

# Levene’s test on the varianc
# Using leveneTest()
car::leveneTest(resid ~ interaction(Generation_Eggs, Genetic_Diversity), data = data_G2_all)

# PairedData::levene.var.test(data_G2_all$dat[df$Genetic_Diversity=="A"], data_G2_all$dat[df$Genetic_Diversity=="B"]) 
# 
# library("PairedData") 
# 
# leveneTest(data_G2_all$resid[data_G2_all$Genetic_Diversity=="High"&
#                                     data_G2_all$Generation_Eggs==2],
#                 data_G2_all$resid[data_G2_all$Genetic_Diversity=="Low"&
#                                     data_G2_all$Generation_Eggs==2])
# 
# 
# ?levene.var.test()
# 
# 
# ?median()
# ?leveneTest()
# 

########### 
########### OPTION C: Check heteroscedasticity of residuals 
########### 
#Breusch-Pagan test 

#library(lmtest)
#lmtest::bptest(Initial_model)
#p-value is not significant (i.e., >0.05), we do not reject the null hypothesis. Therefore, we assume that the residuals are homoscedastic

#library(skedastic)
#install.packages("skedastic")
#skedastic::white_lm(Initial_model)





########### 
########### OPTION D: Test with Levene's test on data
########### 

# Test variances with Levene's test 
tapply(data_G2_all$resid, list(data_G2_all$Generation_Eggs, data_G2_all$Genetic_Diversity),var)

# Levene’s test on the varianc
# Using leveneTest()
car::leveneTest(resid ~ interaction(Generation_Eggs, Genetic_Diversity), data = data_G2_all)

```           
            
### Raw data
```{r }

var_raw_data <- ggplot2::ggplot(data[data$Extinction_finalstatus=="no",], 
                aes(x = factor(Generation_Eggs),  
                                 y = Nb_adults, 
                                 colour = Genetic_Diversity)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(position = position_dodge(0.75), size = 0.7, alpha = 0.5) +
  scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse","Intermediate bottleneck","Strong bottleneck"), 
                    values = c("#00AFBB","#FC4E07", "#E7B800")) +
  ylab("Population size") +
  xlab("Generation") +
  geom_text(x=4, y=450, label="**", size = 5, color = "Black") +
  theme_LO
var_raw_data
# 
# 
# cowplot::save_plot(file = here::here("figures","Variance_rawdata.pdf"),
#                    var_raw_data, base_height = 10/cm(1),           
#                    base_width = 15/cm(1), dpi = 610)






########### 
########### OPTION D: Test with Levene's test on data
########### 

# Test variances with Levene's test 
tapply(data[data$Extinction_finalstatus=="no",]$Nb_adults, 
       list(data[data$Extinction_finalstatus=="no",]$Generation_Eggs,
            data[data$Extinction_finalstatus=="no",]$Genetic_Diversity),var, na.rm=TRUE)

# Levene’s test on the varianc
# Using leveneTest()
car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no",])
car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&data$Generation_Eggs==5,])
car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&data$Generation_Eggs==4,])
car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&data$Generation_Eggs==6,])
car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&data$Generation_Eggs==3,])
car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&data$Generation_Eggs==2,])


car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&
                              data$Generation_Eggs==4&data$Genetic_Diversity!="Medium",])

car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&
                              data$Generation_Eggs==4&data$Genetic_Diversity!="Low",])

car::leveneTest(Nb_adults ~ interaction(Generation_Eggs, Genetic_Diversity), 
                data = data[data$Extinction_finalstatus=="no"&
                              data$Generation_Eggs==4&data$Genetic_Diversity!="High",])

tapply(data[data$Extinction_finalstatus=="no"&
              data$Generation_Eggs==4,]$Nb_adults, 
       data[data$Extinction_finalstatus=="no"&
              data$Generation_Eggs==4,]$Genetic_Diversity, 
       var, 
       na.rm=TRUE)
```           
            
## Growth rate G6
### Distribution analysis
```{r }
head(data_phenotyping)
#Without considering extinct populations 

#tapply(data_phenotyping$Lambda,data_phenotyping$Population,length)

hist(data_phenotyping$Lambda, breaks=50)

# #Which distribution
fitdistrplus::descdist(data_phenotyping$Lambda, discrete = FALSE)


#############################################################
################## Determine distribution ###################
#############################################################
#Test normal
f1 <- fitdistrplus::fitdist(data_phenotyping$Lambda, "norm")
g1 <- fitdistrplus::gofstat(f1)
g1$kstest
plot(f1)
f1$aic

#Test log-normal
f1 <- fitdistrplus::fitdist(data_phenotyping$Lambda+1, "lnorm")
g1 <- fitdistrplus::gofstat(f1)
g1$kstest
plot(f1)
f1$aic

#Test exp
f1 <- fitdistrplus::fitdist(data_phenotyping$Lambda, "exp")
g1 <- fitdistrplus::gofstat(f1)
g1$kstest
plot(f1)
f1$aic

#Test log-normal
f1 <- fitdistrplus::fitdist(data_phenotyping$Lambda+1, "gamma")
g1 <- fitdistrplus::gofstat(f1)
g1$kstest
plot(f1)
f1$aic


## Poisson lognormal model
mlog <- lme4::lmer(log(Lambda+1) ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)
#summary(mlog)

# Square root
msqrt <- lme4::lmer(sqrt(Lambda) ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)
#summary(msqrt)

# Normal
mnorm <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)

# # Log Normal
# mlogN <- glm(log(Lambda) ~ Genetic_Diversity + Block,  
#                      family = gaussian, data=data_phenotyping)



## Compare AIC
AIC(mlog, msqrt,mnorm)
#Square root a better fits to the data 
#But we compare different values: Growth rate and Growth rate+1

# ## Simulate data 
x.teo.log <- unlist(simulate(mlog))
x.teo.sqrt <- unlist(simulate(msqrt))
x.teo.norm <- unlist(simulate(mnorm))

# ## QQplot to compared Negative binomial and Poisson log normal distributions
qqplot(data_phenotyping$Lambda, x.teo.log,
       main="QQ-plot", xlab="Observed data", ylab="Simulated data",
       las=1, xlim = c(0, 10), ylim = c(0, 10), col='blue') ## QQ-plot
points(sort(data_phenotyping$Lambda), sort(x.teo.sqrt), pch=1, col='red')
points(sort(data_phenotyping$Lambda), sort(x.teo.norm), pch=1, col='green')
abline(0,1)
# ## Add legend
legend(0, 7, legend=c("Log", "Sqrt", "Normal"),
       col=c("blue", "red", "green"), 
       pch=1, bty="n")
# ## Normal distribution provides a good fit to the data


# QQ plot
# qqnorm(resid(mlog))
# qqline(resid(mlog))
# qqnorm(resid(msqrt))
# qqline(resid(msqrt))
# qqnorm(resid(mnorm))
# qqline(resid(mnorm)) #best fit

#Distribution Residuals
hist(residuals(mlog),col="yellow",freq=F)
hist(residuals(msqrt),col="yellow",freq=F)  #Seems the better fit
hist(residuals(mnorm),col="yellow",freq=F) #Seems the better fit

#Test normality
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(mnorm), "norm"))
g1$kstest 
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(msqrt), "norm"))
g1$kstest 
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(mnorm), "norm"))
g1$kstest



## Compare AIC
AIC(mlog, msqrt, mnorm)
#SLog a better fits to the data 



```


### Aanalysis
```{r }

#############################################################
##################        Analysis        ###################
#############################################################

mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)

summary(mod0)

mod1 <- lme4::lmer(Lambda ~ Block + (1|Population), 
                   data=data_phenotyping)
anova(mod0,mod1,test="Chisq") # difference


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 

############ 
###### Predict
############
data_predict_extinct <- data.frame(Genetic_Diversity = levels(data_phenotyping$Genetic_Diversity),
                                   Block = "Block4")

data_predict_extinct$predict <- predict(mod0, 
                                        type = "response",
                                        re.form = NA,
                                        newdata = data_predict_extinct)



SUM_GrowthRate <- Rmisc::summarySE(data_phenotyping, 
                        measurevar = c("Lambda"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)



```


## Remaining He difference
```{r }

Rmisc::summarySE(data[data$Generation_Eggs==2,],
          measurevar = c("He_remain"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)


mfull <- lm(He_remain ~ Genetic_Diversity, data=data[data$Generation_Eggs==2,])
mless <- lm(He_remain ~ 1, data=data[data$Generation_Eggs==2,])
anova(mfull,mless) #Keep effect



############ 
###### Posthoc
############ 
emmeans::emmeans(mfull, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 



Rmisc::summarySE(data[data$Generation_Eggs==2,],
          measurevar = c("He_remain"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)




#Calcul for end:
Rmisc::summarySE(data[data$Generation_Eggs==2&data$Extinction_finalstatus!="yes",],
          measurevar = c("He_end"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)

mfull <- lm(He_end ~ Genetic_Diversity, data=data[data$Generation_Eggs==2&data$Extinction_finalstatus!="yes",])
mless <- lm(He_end ~ 1, data=data[data$Generation_Eggs==2&data$Extinction_finalstatus!="yes",])
anova(mfull,mless) #Keep effect




############ 
###### Posthoc
############ 
emmeans::emmeans(mfull, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 






```


## Growth rate and He
```{r }
#Best model with genetic diversity
mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)

mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod1 <- lme4::lmer(Lambda ~ He_end + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod2 <- lme4::lmer(Lambda ~ Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod3 <- lme4::lmer(Lambda ~ log(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod4 <- lme4::lmer(Lambda ~ 1 + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod5 <- lme4::lmer(Lambda ~ exp(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
MuMIn::model.sel(mod0, mod1,mod2,mod3,mod4,mod5)

#Makes sense: best model log He
x <- seq(1:100)
y <- seq(1001:1100)
plot(log(x),y)



#############################################################
##################        Analysis        ###################
#############################################################

mod3 <- lme4::lmer(Lambda ~ log(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod4 <- lme4::lmer(Lambda ~ 1 + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
anova(mod3,mod4,test="Chisq") # difference
summary(mod3)

#############################################################
##################        Predict         ###################
#############################################################

data_predict_lambda <- data.frame(He_end =
  seq(min(data_phenotyping[!is.na(data_phenotyping$He_end),]$He_end),
      max(data_phenotyping[!is.na(data_phenotyping$He_end),]$He_end), 
      0.01),
                                   Block = "Block4")

data_predict_lambda$lambda_predict <- predict(mod3, 
                                        type = "response",
                                        re.form = NA,
                                        newdata = data_predict_lambda)
 
  PLOT_He_expect <- PLOT_He_Final +   geom_line(data = data_predict_lambda, 
                                aes(x = He_end, y = lambda_predict),
                                linetype = "longdash", col = "grey40", size = 1.25) 

# 
# #
# cowplot::save_plot(here::here("figures","Fitness_He_final.pdf"),   PLOT_He_expect,
#           base_height = 12/cm(1), base_width = 18/cm(1), dpi = 610)
# 

```





## Adults G6 
```{r }
m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
summary(m0)

# Equivalent to:
# m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population/ID_Rep),
#                 family = "poisson", data = data_5week)


#dispersion_lme4::glmer(m0) #dispersion ok 
#Note: (1|School) + (1|Class:School) is equivalent to (1|School/Class)

m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") # difference

summary(m0)




############ 
###### Posthoc
############ 
emmeans::emmeans(m0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#test double nested
m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Genetic_Diversity/Population/ID_Rep),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Genetic_Diversity/Population/ID_Rep),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") 

m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Genetic_Diversity/ID_Rep),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Genetic_Diversity/ID_Rep),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") 

``` 



## Adults G2 
```{r }
m0 <- glm(Nb_adults ~ Genetic_Diversity + Block,  family = "poisson", data = data[data$Generation_Eggs==2,])
summary(m0)

m1<- glm(Nb_adults ~ Block,  family = "poisson", data = data[data$Generation_Eggs==2,])
anova(m0,m1,test="Chisq") # difference

############ 
###### Posthoc
############ 
emmeans::emmeans(m0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


``` 





## Proportion life stage
```{r }
##### P_adults 
mod0 <- lme4::glmer(p_adults ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_adults ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference
rm(mod0,mod1)


mod0 <- lme4::glmer(p_adults ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_adults ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference
rm(mod0,mod1)


##### P_adults 
mod0 <- lme4::glmer(p_pupae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_pupae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference

rm(mod0,mod1)

mod0 <- lme4::glmer(p_pupae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_pupae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference

rm(mod0,mod1)

##### P_larvae 
mod0 <- lme4::glmer(p_larvae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_larvae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference and convergence issue


mod0 <- lme4::glmer(p_larvae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_larvae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference and convergence issue






``` 


## Multinomial life stage
```{r }


# data(alligator)
# head(alligator)
# fit <- multinom(food ~ lake+size+sex, data=alligator, weights=count)
# summary(fit$fitted.values)
data_TEMP <- data_phenotyping_all[,c(1:5,11:13,23)]
data_multinom <- tidyr::gather(data_TEMP,"stage","count",6:8)
data_multinom$Divsersity <- as.factor(data_multinom$Divsersity )
head(data_multinom)


fit <- nnet::multinom(stage ~ Divsersity + Week + 
                  ID_Rep + Population, data=data_multinom, weights=count)
summary(fit$fitted.values)
fit

fit0 <- nnet::multinom(stage ~ Divsersity + 
                   ID_Rep + Population , data=data_multinom, weights=count)
anova(fit,fit0)

fit1 <- nnet::multinom(stage ~ Week + 
                   ID_Rep + Population, data=data_multinom, weights=count)
anova(fit,fit1)


### New function to test random effect MCLOGIT
# data_TEMP <- data_phenotyping_all[,c(1:5,17:19,23)]
# data_multinom <- tidyr::gather(data_TEMP,"stage","prop",6:8)
# data_multinom$Divsersity <- as.factor(data_multinom$Divsersity )
# head(data_multinom)


#Other example
library("AER")
library("mlogit")


#### 1- Dataset 1: Train transport
data("TravelMode", package="AER")
head(TravelMode)
#Here: Each individual can choose across 4 modes of transports: air train bus or car
  #We can determine if this choice is random 
    #or determined by different variables as: vcost, travel, etc. 

TM <- mlogit::mlogit.data(data = TravelMode,   #dataset
                          choice = "choice",   #Variable containing the choice: yes or no
                          shape = "long",      #type of  dataset
                          alt.levels = "mode") #Variable contianing the list of choice 

fit0 <- mlogit::mlogit.data(data=data_multinom, 
                            choice = "count", 
                            alt.levels = "stage", 
                            shape = "long")

nb_box <- 14
nb_stage <- 3 
nb_time <- 2

ID_box <- as.factor(rep(rep(c(1:nb_box), nb_stage), nb_time))
pop <- as.factor(rep(rep(c("lowA","lowB","lowC","lowC",
         "medA","medA","medB","medC",
         "highA","highA","highB","highB","highC","highC"), nb_stage), nb_time))
diversity <- as.factor(rep(rep(c(rep("low",4),rep("med",4), rep("high",6)), nb_stage), nb_time))
stage <- as.factor(rep(rep(c("larvae","pupae","adult"),  each=nb_box), nb_time))
timestep <- as.factor(rep(c("t1","t2"), each=nb_box*nb_stage))
count <- c(rpois(nb_box, lambda=10), 
           rpois(nb_box, lambda=10),
           rpois(nb_box, lambda=1),
           rpois(nb_box, lambda=3), 
           rpois(nb_box, lambda=2),
           rpois(nb_box, lambda=20))
data <- data.frame(ID_box,pop,diversity,stage,timestep,count)
head(data)
str(data)



data <- data.frame()


#### 2- Dataset 2: Fishing price 
#https://rdrr.io/cran/mlogit/man/mlogit.html

data("Fishing", package = "mlogit")
head(Fishing)
#There are: 
      #two alternative specific variables : price and catch one individual
      #specific variable (income) 
      #four fishing mode : beach, pier, boat, charter

#A dataframe containing :
  #mode: recreation mode choice, one of : beach, pier, boat and charter,
  #price.beach: price for beach mode
  #price.pier: price for pier mode,
  #price.boat: price for private boat mode,
  #price.charter: price for charter boat mode,
  #catch.beach: catch rate for beach mode,
  #catch.pier: catch rate for pier mode,
  #catch.boat: catch rate for private boat mode,
  #catch.charter: catch rate for charter boat mode,
  #income: monthly income,







``` 



# SUMMARY ALL ANALYSIS 
```{r }
######### Proba of extinction 
mod0 <- glm(y ~ Genetic_Diversity + Block,  
      data = data_proba_extinction, family = binomial)
mod1 <- glm(y ~ Block ,  
      data = data_proba_extinction, family = binomial)
anova(mod1, mod0, test = "Chisq")
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#########Time of extinction
mod1 <- glm(Generation_Eggs ~ Genetic_Diversity + Block,
                    data = data_timeextinction, family = "poisson")
mod0 <- glm(Generation_Eggs ~  Block,
                    data = data_timeextinction, family = "poisson")
anova(mod0, mod1, test = "Chisq")


#########Dynamic over time 
# Test effect
mod_1 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block +   s(Generation_Eggs, k=5) +
                    s(Generation_Eggs, by = Genetic_Diversity, k=5) + 
                    s(Population, bs="re"), method="ML", data=data_dyn)
mod_2 <- mgcv::gam(Nb_adults ~ Genetic_Diversity + Block  +  s(Generation_Eggs, k=5) +
                    s(Population, bs="re"), data=data_dyn, method='ML')

itsadug::compareML(mod_1, mod_2)


#########Growth rate 
mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)
mod1 <- lme4::lmer(Lambda ~ Block + (1|Population), 
                   data=data_phenotyping)
anova(mod0,mod1,test="Chisq") # difference
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#########Growth rate vs. He
mod3 <- lme4::lmer(Lambda ~ log(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod4 <- lme4::lmer(Lambda ~ 1 + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
anova(mod3,mod4,test="Chisq") # difference



##### P_adults 
mod0 <- lme4::glmer(p_adults ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_adults ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


mod0 <- lme4::glmer(p_adults ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_adults ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


##### P_adults 
mod0 <- lme4::glmer(p_pupae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_pupae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


mod0 <- lme4::glmer(p_pupae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_pupae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


##### P_larvae 
mod0 <- lme4::glmer(p_larvae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_larvae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


mod0 <- lme4::glmer(p_larvae ~ Genetic_Diversity + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_larvae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference




``` 





# All analysis with He start or He
```{r }
######### Proba of extinction 
#Prepare clean dataset
data_temp <- data[data$Generation_Eggs==6,c("Block","Population","He_start","Extinction_finalstatus")]
data_temp$Extinction_finalstatus <- as.factor(data_temp$Extinction_finalstatus)
data_temp$y <- ifelse(data_temp$Extinction_finalstatus == "yes", 1, 0)


mod0 <- glm(y ~ He_start + Block,  data = data_temp, family = binomial)
mod1 <- glm(y ~ Block ,   data = data_temp, family = binomial)
anova(mod1, mod0, test = "Chisq")
summary(mod0)




#########Time of extinction
mod1 <- glm(Generation_Eggs ~ He_start + Block,
                    data = data_timeextinction, family = "poisson")
mod0 <- glm(Generation_Eggs ~  Block,
                    data = data_timeextinction, family = "poisson")
anova(mod0, mod1, test = "Chisq")
summary(mod1)



#########Dynamic over time 
# Test effect
mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*He_start + gen_square*He_start + 
                Block  + (1|obs) + (1|Population), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")
mod2 <- lme4::glmer(Nb_adults~Generation_Eggs + gen_square + He_start + 
                Block  + (1|obs) + (1|Population), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], family = "poisson")


#Do not converge
#anova(mod1, mod2, test ="Chisq")  


#########Growth rate 
mod0 <- lme4::lmer(Lambda ~ He_end + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod1 <- lme4::lmer(Lambda ~ Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
anova(mod0,mod1,test="Chisq") # difference


#########Growth rate vs. He
mod3 <- lme4::lmer(Lambda ~ log(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod4 <- lme4::lmer(Lambda ~ 1 + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
anova(mod3,mod4,test="Chisq") # difference





##### P_adults 
mod0 <- lme4::glmer(p_adults ~ He_end + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_adults ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


mod0 <- lme4::glmer(p_adults ~ He_end + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_adults ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


##### P_adults 
mod0 <- lme4::glmer(p_pupae ~ He_end + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_pupae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


mod0 <- lme4::glmer(p_pupae ~ He_end + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_pupae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


##### P_larvae 
mod0 <- lme4::glmer(p_larvae ~ He_end + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_larvae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping_4week,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference


mod0 <- lme4::glmer(p_larvae ~ He_end + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"),
                   weights = Nb_ttx)
mod1 <- lme4::glmer(p_larvae ~ 1 + Block + (1|Population), 
                   data = data_phenotyping,family = binomial(link = "logit"), 
                    weights = Nb_ttx)
anova(mod0,mod1,test="Chisq") # NO difference






``` 










