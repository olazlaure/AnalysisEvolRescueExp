---
title: "Evolutionary rescue experiment: effect of genetic diversity"
author: "Laure Olazcuaga"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()

```


    

# DATA
## Pop sive over time dataset
```{r }
data <- read.table(file=here::here("data", "BE_Census_Data.csv"), sep=",", header=TRUE)
  
head(data)
tail(data)
dim(data)
summary(data)

#Remove populations killed due to the pathogen
data_status  <- data.frame(data$Population,data$Extinction_finalstatus)
data_kill<-data[data$Extinction_finalstatus=="kill",]
dim(data_kill)
data<-data[data$Extinction_finalstatus!="kill",]

#Add pop growth rate
data$Nb_adults <- data$HC_Total_Adults
data$Lambda <- data$Nb_adults / data$Nb_parents
data$obs<-as.factor(1:nrow(data))
#summary(data)
#Remove 

#Check variables
str(data)
data$Genetic_Diversity <- as.factor(data$Genetic_Diversity)
data$Block <- as.factor(data$Block)
data$Population <- as.factor(data$Population)
data$Extinction_finalstatus <- as.factor(data$Extinction_finalstatus)


#Order levels 
data$Genetic_Diversity <- plyr::revalue(data$Genetic_Diversity, c("Med"="Medium"))
data$Genetic_Diversity <- factor(data$Genetic_Diversity, levels = c("High", "Medium", "Low"))
levels(data$Genetic_Diversity)

data<-droplevels(data) #remove previous levels 
str(data)
head(data)
tail(data)
dim(data)

``` 



## Heterozygosity remain over time 
```{r }
#Upload He dataset
data_he <- read.table(file=here::here("data", "He_ReMaining_BeatricePop.csv"), sep=",", header=TRUE)
data_he$Population <- as.factor(data_he$Population)
data_he <- data_he[,c(1,3)]

#Merge dataset: add heterozygosity data to oridinal data 
data <- merge(x = data, y = data_he, by = "Population", all.x=TRUE)

### Creation of 4 He: 
  # 1- He_start: He was remaining for each population when we started the experiment 
  # 2- He_lost_gen_t: He was lost only during this specfic generation during the experiment  (considering He=1 before this generation)
  # 3- He_remain: He was remaining after each generation (He_remain[Gen=6]=He_end)
  # 4- He_exp: He was lost during the entire experiment (considering He=1 at the beginning of the exp)
  # 5- He_end: He was remaining for each population when we finished the experiment (considering the real He at the beginning of the exp, He_start, not 1)


##### 
##### 1- He_start
#####
colnames(data)[27] <- "He_start"



##### 
##### 2- He_lost_gen_t
##### 
#Add He lost each generation
data$He_lost_gen_t <- 1 - (1/(2*data$Nb_adults))
#To consider extinct populations
is.na(data$He_lost_gen_t) <- sapply (data$He_lost_gen_t, is.infinite)


##### 
##### 3- He_remain
##### 
#Create new variable He remain per generation
data$He_remain <- NA
#Initiate with gen=1: He_start * He_lost_gen1
data$He_remain[data$Generation_Eggs=="1"] <- data$He_start[data$Generation_Eggs=="1"]*
  data$He_lost_gen_t[data$Generation_Eggs=="1"]

#Compute for all the other genrations, except the first one 
for(i in levels(data$Population)){
     ifelse(sum(data$Generation_Eggs[data$Population==i])!=21,print("ERROR"),print(i))
 for(j in 2:max(data$Generation_Eggs)){
   data$He_remain[data$Population==i&data$Generation_Eggs==j] <- 
     data$He_remain[data$Population==i&data$Generation_Eggs==j-1]*
     data$He_lost_gen_t[data$Population==i&data$Generation_Eggs==j]
   }
}




##### 
##### 4- He_exp
##### 
# He at the end of the experiment 
data$He_exp <- NA 

#Compute the HE at the end of the experiment 
for(i in levels(data$Population)){
temp_data_pop <- subset(data, Population==i)
ifelse(sum(temp_data_pop$Generation_Eggs)!=21,print("ERROR"),print(i))
temp_he_remaining_gen <- 1 - (1/(2*temp_data_pop$Nb_adults))
#To consider extinct add this row: 
is.na(temp_he_remaining_gen) <- sapply (temp_he_remaining_gen, is.infinite)
#Compute for the whole experiment 
temp_he_remain_exp <- prod(temp_he_remaining_gen, na.rm = TRUE)
data$He_exp[data$Population==i] <- temp_he_remain_exp
rm(temp_he_remain_exp,temp_he_remaining_gen,temp_data_pop)
}


##### 
##### 5- He_end
##### 
# Remaining He at the end of the experiment
data$He_end <- data$He_start * data$He_exp

#Save these values for Phenotyping 
data_he <- merge(x = data_he, 
                 y = data[data$Generation_Eggs==1,
                          c("Population","He_start",
                             "He_exp","He_end")], 
                 by = "Population", all.x=TRUE)
```


## Phenotyping dataset
```{r }
#Upload growth rate end of experiment
data_phenotyping <- read.table(file=here::here("data", "Adaptation_Data.csv"), sep=",", header=TRUE)


#Factors variables 
data_phenotyping$ID_Rep <- as.factor(data_phenotyping$ID_Rep)
data_phenotyping$Week <- as.factor(data_phenotyping$Week)
data_phenotyping$Block <- as.factor(data_phenotyping$Block)
data_phenotyping$Population <- as.factor(data_phenotyping$Population)
#Revalue
data_phenotyping$Genetic_Diversity <- as.factor(data_phenotyping$Divsersity)
data_phenotyping$Genetic_Diversity <-   plyr::revalue(data_phenotyping$Genetic_Diversity, c("Med"="Medium"))
data_phenotyping$Genetic_Diversity <- factor(data_phenotyping$Genetic_Diversity, 
                                             levels = c("High", "Medium", "Low"))



#Add sum total 
data_phenotyping$Nb_ttx <- rowSums(data_phenotyping[,11:13], na.rm=TRUE)
#Proportion
data_phenotyping$p_adults <- data_phenotyping$Adults  / data_phenotyping$Nb_ttx
data_phenotyping$p_pupae <- data_phenotyping$Pupae / data_phenotyping$Nb_ttx
data_phenotyping$p_larvae <- data_phenotyping$Larvae / data_phenotyping$Nb_ttx

data_phenotyping_all <- data_phenotyping
data_phenotyping <- data_phenotyping[data_phenotyping$Week=="5-week",]




#Merge with He dataset
data_phenotyping <- merge(x = data_phenotyping, 
              y = data_he, by = "Population", all.x=TRUE)

#Clean if less than 30 parents 
pop_possible<-unique(data$Population[data$Generation_Eggs==5&data$Nb_adults>=30])
data_phenotyping <- data_phenotyping[data_phenotyping$Population %in% pop_possible,]


``` 



## Old He remain 
```{r }
#Upload growth rate end of experiment
data_he <- read.table(file=here::here("data", "He_ReMaining_BeatricePop.csv"), sep=",", header=TRUE)
data_he$Population <- as.factor(data_he$Population)
data_he <- data_he[,c(1,3)]


### Additional: He remaining 
# New vector for the lost during exp
data_he$He_remain_exp <- NA

# He lost during exp
for(i in levels(data$Population)){
temp_data_pop <- subset(data, Population==i)
ifelse(sum(temp_data_pop$Generation_Parents)!=15,print("ERROR"),print(i))
temp_he_remaining_gen <- 1 - (1/(2*temp_data_pop$Nb_parents))

#To consider extinct add this row: 
is.na(temp_he_remaining_gen) <- sapply (temp_he_remaining_gen, is.infinite)

temp_he_remain_exp <- prod(temp_he_remaining_gen, na.rm = TRUE)
data_he$He_remain_exp[data_he$Population==i] <- temp_he_remain_exp
rm(temp_he_remain_exp,temp_he_remaining_gen,temp_data_pop)
}

# Remaining He at the end of the experiment
data_he$He_end <- data_he$He_remain * data_he$He_remain_exp

# Remove kill population 
data_he <- data_he[!is.na(data_he$He_remain_exp),]
data_he <- droplevels(data_he)

## Merge dataset He
data_old_merged <- merge(x = data, y = data_he, by = "Population", all.x=TRUE)

```


# PLOT 
## Population size
```{r }
PLOT_Pop_size<-ggplot2::ggplot(data, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Population,
                                colour = Genetic_Diversity)) + 
  geom_point(position = position_dodge(0.4), size = 0.8, alpha = 0.7) +
  geom_line(position = position_dodge(0.4), size = 0.2, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size

SUM_Popsize <- Rmisc::summarySE(data, 
                        measurevar = c("Nb_adults"),
                       groupvars = c("Generation_Eggs",
                                     "Genetic_Diversity"), 
                       na.rm=TRUE)
SUM_Popsize

# SUM_Popsize <- Rmisc::summarySE(data[data$Extinction_finalstatus=="no",],
#                         measurevar = c("Nb_adults"),
#                        groupvars = c("Generation_Eggs",
#                                      "Genetic_Diversity"),
#                        na.rm=TRUE)
# SUM_Popsize



PLOT_Pop_size_average <- PLOT_Pop_size + 
  geom_point(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 5, position = position_dodge(0.4)) +
  geom_errorbar(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                ymin = Nb_adults-ci, ymax = Nb_adults+ci, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
             size = 1, width=.2,  position = position_dodge(0.4)) +
  geom_line(data = SUM_Popsize, aes(x = factor(Generation_Eggs), 
                                y = Nb_adults, 
                                group = Genetic_Diversity,
                                colour = Genetic_Diversity), 
           linetype = "dashed", size = 1.5, position = position_dodge(0.4)) 
PLOT_Pop_size_average
# cowplot::save_plot(file = here::here("figures","PopulationSize_average.pdf"),   PLOT_Pop_size_average, base_height = 10/cm(1),           base_width = 15/cm(1), dpi = 610)






#Prediction with models 
# Test effect

data$gen_square <- data$Generation_Eggs^2
mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs), 
            data = data[data$Generation_Eggs>=2&data$Extinction_finalstatus=="no",], 
            family = "poisson")

#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(2,6, length = 100),each=3),
                       Block = "Block4",
                       gen_square = (rep(seq(2,6, length = 100),each=3))^2,
                       Estimates = NA)

filldata$Estimates <- predict(mod1, newdata=filldata, type = "response", re.form=~0)


#Predcit estimate minimun values 
tapply(filldata$Estimates, filldata$Genetic_Diversity, min)

filldata[filldata$Estimates>=44.16&filldata$Estimates<=44.17,]
filldata[filldata$Estimates>=51.99&filldata$Estimates<=52.00,]
filldata[filldata$Estimates>=85.85&filldata$Estimates<=85.86,]


## Change name vector 
vector_names <- c(`Low` = "Extreme bottleneck",
                    `Medium` = "Strong bottleneck",
                    `High` = "Diverse-source")


PLOT_Pop_size_predict<-ggplot2::ggplot(data[data$Extinction_finalstatus=="no",], 
                               aes(x = factor(Generation_Eggs), 
                                y = Nb_adults)) + 
  geom_point(aes(group = Population,
                 colour = Genetic_Diversity), 
             position = position_dodge(0.4), size = 0.7, alpha = 0.5) +
  geom_line(aes(group = Population,
                colour = Genetic_Diversity), 
            position = position_dodge(0.4), size = 0.05, alpha = 0.5) +
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.4) + 
  scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse-source","Strong bottleneck","Extreme bottleneck"), 
                    values = c("#00AFBB", "#E7B800", "#FC4E07")) +
  ylab("Population size") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size_predict
# 
# cowplot::save_plot(file = here::here("figures","PopulationSize_predict.pdf"),   PLOT_Pop_size_predict, base_height = 10/cm(1),           base_width = 15/cm(1), dpi = 610)



``` 




## Extinction
```{r }
#Percent of extinction
length(unique(data$Population[data$Genetic_Diversity=="Low"&
                                data$Extinction_finalstatus=="yes"]))/
  length(unique(data$Population[data$Genetic_Diversity=="Low"]))

length(unique(data$Population[data$Genetic_Diversity=="Medium"&
                                data$Extinction_finalstatus=="yes"]))/
length(unique(data$Population[data$Genetic_Diversity=="Medium"]))
 
length(unique(data$Population[data$Genetic_Diversity=="High"&
                                data$Extinction_finalstatus=="yes"]))/
  length(unique(data$Population[data$Genetic_Diversity=="High"]))

#Create data with percent
vector_names <- c(`Low` = "Extreme bottleneck",
                    `Medium` = "Strong bottleneck",
                    `High` = "Diverse-source")
f_labels = data.frame(Genetic_Diversity = c("High","Medium","Low"), 
                       label = c("Extinction = 0 %", "Extinction = 21.7 %", "Extinction = 23.5 %"))
f_labels$Genetic_Diversity <- factor(f_labels$Genetic_Diversity, 
                                     levels = c("High", "Medium", "Low"))






## Extinction yes no
PLOT_Extinction<-ggplot2::ggplot(data,  aes(x = factor(Generation_Eggs), 
                                y = Nb_adults)) + 
  facet_wrap(~ Genetic_Diversity, ncol=3, labeller = ggplot2::as_labeller(vector_names)) + 
  #geom_point(position = position_dodge(0.4), size = 0.4, alpha = 0.7) +
  geom_line(aes(group = Population,
                colour = Extinction_finalstatus), 
            position = position_dodge(0.1), size = 0.4, alpha = 0.8) +
  geom_text(x = 5, y = 420, 
            aes(label = label), 
            data = f_labels, 
            col="red", 
            size = 3, 
            vjust = 0) +
  scale_color_manual(values = c("black", "red")) +
  ylab("Population size") +
  xlab("Generation") +
  theme(legend.position = "none") +
  theme_LO
PLOT_Extinction
# 
# 
# cowplot::save_plot(here::here("figures","Extinction.pdf"),   PLOT_Extinction, base_height = 8/cm(1),
#           base_width = 20/cm(1), dpi = 610)
# # 
# 
# 


PLOT_Extinction 

    
``` 



## Growth rate G2
```{r }
tapply(data[data$Generation_Eggs==2,]$Lambda,data[data$Generation_Eggs==2,]$Genetic_Diversity,mean)

PLOT_Growth<-ggplot2::ggplot(data[data$Generation_Eggs==2,], aes(x = Genetic_Diversity, y = Lambda, 
                         colour = Genetic_Diversity)) + 
  geom_boxplot(aes(group = Genetic_Diversity),outlier.colour = NA) +
  geom_jitter(width = 0.25, size = 1, alpha = 0.8) +
  ylab("Growth rate") +
  theme(legend.position = "none") +
  xlab("Genetic diversity") +
  theme_LO
PLOT_Growth
# 
# cowplot::save_plot(here::here("figures","OldPlot_Growth_Start.pdf"),   PLOT_Growth, base_height = 10/cm(1),
#           base_width = 8/cm(1), dpi = 610)



``` 




## Life stage proportion
```{r }


SUM_Prop_adults<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_adults"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_adults

SUM_Prop_pupae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_pupae"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_pupae

SUM_Prop_larvae<- Rmisc::summarySE(data_phenotyping_all, 
                        measurevar = c("p_larvae"),
                       groupvars = c("Genetic_Diversity","Week"), 
                       na.rm = TRUE)
SUM_Prop_larvae

SUM_Prop <- data.frame(SUM_Prop_adults[,1:4],
                       p_pupae=SUM_Prop_pupae$p_pupae,
                       p_larvae=SUM_Prop_larvae$p_larvae)


SUM_Prop<-tidyr::gather(SUM_Prop,"Stage", "Proportion",4:6,-"Genetic_Diversity")
SUM_Prop
SUM_Prop$Stage <- factor(SUM_Prop$Stage, levels = c("p_adults", "p_pupae", "p_larvae"))





PLOT_prop <- ggplot2::ggplot(data = SUM_Prop, aes(x = Genetic_Diversity, 
                                                  y = Proportion, fill = Stage)) +
  facet_wrap(~ Week, ncol=2) +
  geom_bar(stat="identity") + 
  xlab("Genetic history") +
  labs(color="Stage of individuals") +
  ylab("Proportion of each stage") +
  scale_fill_manual(values= c("#619CFF","#F8766D","#00BA38"), 
                    breaks = c("p_adults", "p_pupae", "p_larvae"),
                    labels = c( "Adult", "Pupae","Larvae")) + 
  ggplot2::scale_x_discrete(breaks=c("High", "Medium", "Low"), 
                            labels=c("Diverse-\nsource", 
                                     "Strong \nbottleneck", 
                                      "Extreme \nbottleneck")) + 
  theme_LO
PLOT_prop

# 
# cowplot::save_plot(here::here("figures","Life_stage_proportion.pdf"),   PLOT_prop,
#           base_height = 10/cm(1), base_width = 18/cm(1), dpi = 610)


``` 


## Remaining heterozygosity
```{r }

# Remove pseudoreplication: average of each population
SUM_POP_He_Mean<- Rmisc::summarySE(data_phenotyping,
                            measurevar = c("Lambda"),
                            groupvars = c("Genetic_Diversity",
                                          "He_end",
                                          "Population"), 
                            na.rm=TRUE)


PLOT_He_Final <- ggplot2::ggplot(SUM_POP_He_Mean, aes(x = He_end,
                                                      y = Lambda, 
                                                      colour = Genetic_Diversity, 
                                                      size = N)) + 
    geom_point(alpha = 0.8) +
    ylab("Growth rate") +
    xlab("Expected heterozygosity") +
    scale_color_manual(name="Genetic history",
                     breaks = c("High", "Medium", "Low"), 
                    labels = c("Diverse-source","Strong bottleneck","Extreme bottleneck"), 
                    values = c("#00AFBB", "#E7B800", "#FC4E07")) + 
    labs(size="Replicates") + 
    theme_LO 
PLOT_He_Final
# 
#    
# cowplot::save_plot(here::here("figures","Heterozygosity_Growthrate.pdf"),
#                    PLOT_He_Final,
#           base_height = 12/cm(1), base_width = 16/cm(1), dpi = 610)
# 




# # ALL WITHOUT PSEUDO
# SUM_POP_He_ALL<- Rmisc::summarySE(data_evolution_Lambda,
#                             measurevar = c("Lambda"),
#                        groupvars = c("Genetic_Diversity","Phenotyping", "He_remain", "He_end",
#                                      "Population"), 
#                        na.rm=TRUE)
# 
# SUM_POP_He_ALL$HE <- ifelse(SUM_POP_He_ALL$Phenotyping=="Initial",SUM_POP_He_ALL$He_remain,SUM_POP_He_ALL$He_end)
# 
# SUM_POP_He_ALL <- SUM_POP_He_ALL[!is.na(SUM_POP_He_ALL$He_end),]
# SUM_POP_He_ALL <- SUM_POP_He_ALL[SUM_POP_He_ALL$HE!="-Inf",]
# 
# 
# facet_names <- c('Initial'="Before rescue experiment",'Final'="After rescue experiment")
# 
# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda, 
#                          colour = Genetic_Diversity, 
#                          shape = Phenotyping)) +
#   #facet_wrap(~ Phenotyping, ncol=1) +
#   geom_point(size = 3, alpha = 0.8) +
#   scale_shape_manual(values = c(1, 19)) + 
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO 
# PLOT_He_ALL
# 
# 
# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda, 
#                          colour = Genetic_Diversity, 
#                          shape = Phenotyping)) +
#   facet_wrap(~ Phenotyping, ncol=1) +
#   geom_point(size = 3, alpha = 0.8) +
#   scale_shape_manual(values = c(1, 19)) + 
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO
# PLOT_He_ALL
# 
# 
# PLOT_He_ALL <- ggplot2::ggplot(SUM_POP_He_ALL, aes(x = HE, y = Lambda,
#                          colour = Genetic_Diversity)) +
#   facet_wrap(~ Phenotyping, ncol=1) +
#   geom_point(size = 3, alpha = 0.8) +
#   ylab("Growth rate") +
#   xlab("Remaining heterozygosity") +
#   theme_LO
# PLOT_He_ALL


``` 

## He over time 
```{r }

#Compute for all the other genrations, except the first one 
data$ID_extinction <- "extant"

for(i in unique(data$Population[data$Extinction_finalstatus=="yes"])){
    gen_all <- data$Generation_Eggs[data$Population==i&!is.na(data$He_remain)]
    maxgen <- max(gen_all)
    data$ID_extinction[data$Population==i&data$Generation_Eggs==maxgen] <- "willextinct" 
}

data[data$ID_extinction=="willextinct",]
dim(data[data$ID_extinction=="willextinct",])
data[data$ID_extinction=="willextinct","Population"]

data$Population[data$Genetic_Diversity=="Medium"&data$Extinction_finalstatus=="yes"]
  

PLOT_He_extinction <-ggplot2::ggplot(data, aes(x = factor(Generation_Eggs), 
                                y = He_remain, 
                                group = Population,
                                colour = Extinction_finalstatus, 
                                shape = ID_extinction)) + 
  geom_point(position = position_dodge(0.5), size = 3, alpha = 0.6) +
  geom_line(position = position_dodge(0.5), size = 0.25, alpha = 0.4) +
  ylab("Expected heterozygozity") +
  scale_color_manual(values = c("black", "red")) +
  scale_shape_manual(values = c(16, 13), guide=FALSE) +
  labs(color="Extinct populations") +
  xlab("Generation") +
  theme_LO
PLOT_He_extinction
# 
# cowplot::save_plot(here::here("figures","Heterozygosity_over_time.pdf"),
#                    PLOT_He_extinction,
#           base_height = 12/cm(1), base_width = 14/cm(1), dpi = 610)



``` 



# ANALYSIS 
## Probability of extinction
```{r }
############ 
###### Clean dataset
############ 
#Prepare clean dataset
data_proba_extinction <- data[data$Generation_Eggs==6,c("Block","Population","Genetic_Diversity","Extinction_finalstatus")]
data_proba_extinction$Extinction_finalstatus <- as.factor(data_proba_extinction$Extinction_finalstatus)
data_proba_extinction$y <- ifelse(data_proba_extinction$Extinction_finalstatus == "yes", 1, 0)



############ 
###### Analysis
############ 
#Analysis
mod0 <- glm(y ~ Genetic_Diversity + Block,  
      data = data_proba_extinction, family = binomial)


summary(mod0)


#Test genetic diversity effect
mod1 <- glm(y ~ Block ,  
      data = data_proba_extinction, family = binomial)
anova(mod1, mod0, test = "Chisq")
#We keep genetic diversity 

# Perform the lrtest 
(A <- logLik(mod1))
(B <- logLik(mod0))
#Since the logLik() function gives more information than the numeric value, use the as.numeric() function to isolate the numeric value
(teststat <- -2 * (as.numeric(A)-as.numeric(B)))
#df = 5 - 3 = 2
(p.val <- pchisq(teststat, df = 2, lower.tail = FALSE))

lmtest::lrtest(mod1, mod0)



mod0 <- glm(y ~ Genetic_Diversity-1 + Block ,  
      data = data_proba_extinction, family = binomial)
summary(mod0)



############ 
###### Predicted value
############ 
#Extract probability of extinction 
(p_high <- plogis(-21.3144))
(p_med <- plogis(-3.0142))
(p_low <- plogis(-2.8082))

data_predict_extinct <- data.frame(Genetic_Diversity = levels(data_proba_extinction$Genetic_Diversity),
                                   Block = "Block4")

data_predict_extinct$predict <- predict(mod0, type = "response",
        re.form = NA,
        newdata = data_predict_extinct)
        
data_predict_extinct
p_high
p_med
p_low


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


``` 



## Population size G6
```{r }

############ 
###### Analysis
############ 
#Analysis
# mod0 <- lme4::glmer(Nb_adults ~ Genetic_Diversity + Block + (1|Population),  
#       data = data[data$Generation_Eggs==6,], family = "poisson")


mod0 <- lm(log(Nb_adults) ~ Genetic_Diversity + Block, 
             data = data[data$Generation_Eggs==6&data$Extinction_finalstatus == "no",])

mod1 <- lm(log(Nb_adults) ~ Block , 
             data = data[data$Generation_Eggs==6&data$Extinction_finalstatus == "no",])

anova(mod0, mod1) # Effect of genetic diversity 

mod0 <- lm(log(Nb_adults) ~ Genetic_Diversity + Block, 
             data = data[data$Generation_Eggs==6&data$Extinction_finalstatus == "no",])


summary(mod0)


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 

``` 



## Population size over time
```{r }


####################### 
####################### MODEL INCLUDING GENETIC DIVERSITY WITHOUT GEN 1  
####################### 
###################### REMOVE GEN 1 ##########################33

#If we dont consider Gen=1 
PLOT_Pop_size_average
fit <- lm(log(Nb_adults+1) ~ Generation_Eggs, data = data[data$Generation_Eggs>=2,])
#second degree
fit2 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,2,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#third degree
fit3 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,3,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#fourth degree
fit4 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,4,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#fourth degree
fit5 <- lm(log(Nb_adults+1)~stats::poly(Generation_Eggs,5,raw=TRUE), data = data[data$Generation_Eggs>=2,])
#exp
fit6 <- lm(log(Nb_adults+1)~exp(Generation_Eggs), data = data[data$Generation_Eggs>=2,])
#log
fit7 <- lm(log(Nb_adults+1)~log(Generation_Eggs), data = data[data$Generation_Eggs>=2,])

fit <- glm(Nb_adults ~ Generation_Eggs, 
           data = data[data$Generation_Eggs>=2,], family = "poisson")
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
fit3 <- glm(Nb_adults~stats::poly(Generation_Eggs,3,raw=TRUE), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
fit5 <- glm(Nb_adults~stats::poly(Generation_Eggs,5,raw=TRUE), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
fit6 <- glm(Nb_adults~exp(Generation_Eggs), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
fit7 <- glm(Nb_adults~log(Generation_Eggs), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")





#generate range of 50 numbers starting from 30 and ending at 160
# xx <- seq(1,6, length=100)
# plot(data[data$Generation_Eggs>=2,]$Generation_Eggs,
#      log(data[data$Generation_Eggs>=2,]$Nb_adults+1),pch=19,ylim=c(0,8))
# lines(xx, predict(fit, data.frame(Generation_Eggs=xx)), col="red")
# lines(xx, predict(fit2, data.frame(Generation_Eggs=xx)), col="green")
# lines(xx, predict(fit3, data.frame(Generation_Eggs=xx)), col="blue")
# lines(xx, predict(fit4, data.frame(Generation_Eggs=xx)), col="purple")
# lines(xx, predict(fit5, data.frame(Generation_Eggs=xx)), col="yellow")
# lines(xx, predict(fit6, data.frame(Generation_Eggs=xx)), col="orange")
# lines(xx, predict(fit7, data.frame(Generation_Eggs=xx)), col="pink")
xx <- seq(1,6, length=100)
plot(data[data$Generation_Eggs>=2,]$Generation_Eggs,
     data[data$Generation_Eggs>=2,]$Nb_adults,pch=19)
lines(xx, predict(fit, data.frame(Generation_Eggs=xx),type = "response"), col="red")
lines(xx, predict(fit2, data.frame(Generation_Eggs=xx),type = "response"), col="green")
lines(xx, predict(fit3, data.frame(Generation_Eggs=xx),type = "response"), col="blue")
lines(xx, predict(fit4, data.frame(Generation_Eggs=xx),type = "response"), col="purple")
lines(xx, predict(fit5, data.frame(Generation_Eggs=xx),type = "response"), col="yellow")
lines(xx, predict(fit6, data.frame(Generation_Eggs=xx),type = "response"), col="orange")
lines(xx, predict(fit7, data.frame(Generation_Eggs=xx),type = "response"), col="pink")


# Check the r squared
rsq::rsq(fit,adj=TRUE)
rsq::rsq(fit2,adj=TRUE)
rsq::rsq(fit3,adj=TRUE)
rsq::rsq(fit4,adj=TRUE)
rsq::rsq(fit5,adj=TRUE)
rsq::rsq(fit6,adj=TRUE)
rsq::rsq(fit7,adj=TRUE)

# Best model is fit 2


data$gen_square <- data$Generation_Eggs^2
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
fit2 <- glm(Nb_adults~Generation_Eggs + gen_square, 
            data = data[data$Generation_Eggs>=2,], family = "poisson")

# fit2 <- lm(log(Nb_adults+1)~poly(Generation_Eggs,2,raw=TRUE), data = data[data$Generation_Eggs>=2,])
# fit2 <- lm(log(Nb_adults+1)~ Generation_Eggs + gen_square, data = data[data$Generation_Eggs>=2,])
#Add the interaction with Genetic diversity
fit2 <- glm(Nb_adults~ Generation_Eggs*Genetic_Diversity +
             gen_square*Genetic_Diversity,
           data = data, family = "poisson")


summary(fit2)

####### Add genetic diversity 

#Test oversdispersion
mod0 <- glm(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
              Block , 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
sqrt(deviance(mod0)/(nobs(mod0)-length(coef(mod0))))
sigma(mod0)
# ccl: overdispersion


mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
blmeco::dispersion_glmer(mod1)
sigma(mod1)

#Convergence issue 
max(abs(with(mod1@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001



# Test effect
mod1 <- lme4::glmer(Nb_adults~Generation_Eggs*Genetic_Diversity + gen_square*Genetic_Diversity + 
                Block  + (1|obs), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
mod2 <- lme4::glmer(Nb_adults~Generation_Eggs + gen_square + Genetic_Diversity + 
                Block  + (1|obs), 
            data = data[data$Generation_Eggs>=2,], family = "poisson")
anova(mod1, mod2, test ="Chisq")  



#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(2,6, length = 100),each=3),
                       Block = "Block4",
                       gen_square = (rep(seq(2,6, length = 100),each=3))^2,
                       Estimates = NA)

filldata$Estimates <- predict(mod1, newdata=filldata, type = "response", re.form=~0)


#Plot
PLOT_Pop_size <- ggplot2::ggplot(data = data[data$Generation_Eggs>=2,]) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.3) +
  geom_point(data = data, 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size

emmeans::emmeans(mod1, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 




###################################################################
###################################################################
###################################################################
####################  INCLUDING GEN 1 ###########################
PLOT_Pop_size_average
fit <- glm(Nb_adults ~ Generation_Eggs, data = data, family = "poisson")
#second degree
fit2 <- glm(Nb_adults~stats::poly(Generation_Eggs,2,raw=TRUE), data = data, family = "poisson")
#third degree
fit3 <- glm(Nb_adults~stats::poly(Generation_Eggs,3,raw=TRUE), data = data, family = "poisson")
#fourth degree
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), data = data, family = "poisson")
#fourth degree
fit5 <- glm(Nb_adults~stats::poly(Generation_Eggs,5,raw=TRUE), data = data, family = "poisson")
#exp
fit6 <- glm(Nb_adults~exp(Generation_Eggs), data = data, family = "poisson")
#log
fit7 <- glm(Nb_adults~log(Generation_Eggs), data = data, family = "poisson")


#generate range of 50 numbers starting from 30 and ending at 160
xx <- seq(1,6, length=100)
plot(data$Generation_Eggs,
     data$Nb_adults,pch=19)
lines(xx, predict(fit, data.frame(Generation_Eggs=xx),type = "response"), col="red")
lines(xx, predict(fit2, data.frame(Generation_Eggs=xx),type = "response"), col="green")
lines(xx, predict(fit3, data.frame(Generation_Eggs=xx),type = "response"), col="blue")
lines(xx, predict(fit4, data.frame(Generation_Eggs=xx),type = "response"), col="purple")
lines(xx, predict(fit5, data.frame(Generation_Eggs=xx),type = "response"), col="yellow")
lines(xx, predict(fit6, data.frame(Generation_Eggs=xx),type = "response"), col="orange")
lines(xx, predict(fit7, data.frame(Generation_Eggs=xx),type = "response"), col="pink")

# Check the r squared
summary(fit)$adj.r.squared
summary(fit2)$adj.r.squared
summary(fit3)$adj.r.squared
summary(fit4)$adj.r.squared # best r square
summary(fit5)$adj.r.squared 
summary(fit6)$adj.r.squared 
summary(fit7)$adj.r.squared 

rsq::rsq(fit,adj=TRUE)
rsq::rsq(fit2,adj=TRUE)
rsq::rsq(fit3,adj=TRUE)
rsq::rsq(fit4,adj=TRUE)
rsq::rsq(fit5,adj=TRUE)
rsq::rsq(fit6,adj=TRUE)
rsq::rsq(fit7,adj=TRUE)



#
fit4 <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE), data = data, family = "poisson")



####################### 
####################### MODEL INCLUDING GENETIC DIVERSITY and GEN 1 
####################### 

#Test oversdispersion
fit4 <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + (1|Block), data = data, family = "poisson")
blmeco::dispersion_glmer(fit4)

mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
blmeco::dispersion_glmer(mod)


#Convergence issue 
max(abs(with(mod@optinfo$derivs, solve(Hessian, gradient)))) #should be <0.001

#Predict data
filldata <- data.frame(Genetic_Diversity = rep(levels(data$Genetic_Diversity),100), 
                       Generation_Eggs = rep(seq(1,6, length = 100),each=3),
                       Block = "Block4", 
                       Estimates = NA)
filldata$Estimates <- predict(fit4, newdata=filldata, type = "response")


#Plot
PLOT_Pop_size <- ggplot2::ggplot(data = data) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates, 
                               colour = Genetic_Diversity), size = 1.3) +
  geom_point(data = data, 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.6) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size




# fit2 <- lm(log(Nb_adults+1)~ Generation_Eggs*Genetic_Diversity + 
#              gen_square*Genetic_Diversity, 
#            data = data[data$Generation_Eggs>=2,])
# fit2_test <- lm(log(Nb_adults+1)~ Generation_Eggs+Genetic_Diversity + 
#              gen_square, 
#            data = data[data$Generation_Eggs>=2,])

mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
mod1 <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)+Genetic_Diversity + 
               (1|Block) + (1|obs), data = data, family = "poisson")
anova(mod,mod1, test = "Chisq")
#Signifcant interaction 
summary(mod)
summary(mod1)


emmeans::emmeans(mod, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 





####################### 
####################### MODEL INCLUDING ONLY RESCUED POPULATIONS
####################### 
#Same but only for population not extinct
fit_fin <- glm(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity,
            data = data[data$Extinction_finalstatus=="no",], family = "poisson")

filldata$Estimates_Withoutextpop <- predict(fit_fin, newdata=filldata, type = "response")

PLOT_Pop_size <- ggplot2::ggplot(data = data) + 
  geom_line(data = filldata, aes(x = Generation_Eggs, 
                                y = Estimates_Withoutextpop, 
                               colour = Genetic_Diversity), size = 1.5, linetype = "longdash") +
  geom_point(data = data[data$Extinction_finalstatus=="no",], 
                      aes(x = Generation_Eggs, 
                                y = Nb_adults, 
                                colour = Genetic_Diversity),
             position = position_dodge(0.4), size = 1.4, alpha = 0.5) +
  ylab("Population size") +
  labs(color="Genetic diversity") +
  xlab("Generation") +
  theme_LO
PLOT_Pop_size




mod <- lme4::glmer(Nb_adults~stats::poly(Generation_Eggs,4,raw=TRUE)*Genetic_Diversity + 
               (1|Block) + (1|obs), 
             data = data[data$Extinction_finalstatus=="no",], family = "poisson")
mod1 <- lme4::glmer(Nb_adults~poly(Generation_Eggs,4,raw=TRUE)+Genetic_Diversity + 
               (1|Block) + (1|obs), 
              data = data[data$Extinction_finalstatus=="no",], family = "poisson")
anova(mod,mod1, test = "Chisq")


summary(mod)

emmeans::emmeans(mod, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#Signifcant interaction 
``` 



## Growth rate G6
```{r }
head(data_phenotyping)
#Without considering extinct populations 

#tapply(data_phenotyping$Lambda,data_phenotyping$Population,length)




#############################################################
################## Determine distribution ###################
#############################################################

## Poisson lognormal model
mlog <- lme4::lmer(log(Lambda+1) ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)
#summary(mlog)

# Square root
msqrt <- lme4::lmer(sqrt(Lambda) ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)
#summary(msqrt)

# Normal
mnorm <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)


## Compare AIC
AIC(mlog, msqrt,mnorm)
#Square root a better fits to the data 
#But we compare different values: Growth rate and Growth rate+1

# ## Simulate data 
x.teo.log <- unlist(simulate(mlog))
x.teo.sqrt <- unlist(simulate(msqrt))
x.teo.norm <- unlist(simulate(mnorm))

# ## QQplot to compared Negative binomial and Poisson log normal distributions
qqplot(data_phenotyping$Lambda, x.teo.log,
       main="QQ-plot", xlab="Observed data", ylab="Simulated data",
       las=1, xlim = c(0, 10), ylim = c(0, 10), col='blue') ## QQ-plot
points(sort(data_phenotyping$Lambda), sort(x.teo.sqrt), pch=1, col='red')
points(sort(data_phenotyping$Lambda), sort(x.teo.norm), pch=1, col='green')
abline(0,1)
# ## Add legend
legend(0, 7, legend=c("Log", "Sqrt", "Normal"),
       col=c("blue", "red", "green"), 
       pch=1, bty="n")
# ## Normal distribution provides a good fit to the data


# QQ plot
# qqnorm(resid(mlog))
# qqline(resid(mlog))
# qqnorm(resid(msqrt))
# qqline(resid(msqrt))
# qqnorm(resid(mnorm))
# qqline(resid(mnorm)) #best fit

#Distribution Residuals
hist(residuals(mlog),col="yellow",freq=F)
hist(residuals(msqrt),col="yellow",freq=F)  #Seems the better fit
hist(residuals(mnorm),col="yellow",freq=F) #Seems the better fit

#Test normality
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(mnorm), "norm"))
g1$kstest 
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(msqrt), "norm"))
g1$kstest 
g1 <- fitdistrplus::gofstat(fitdistrplus::fitdist(residuals(mnorm), "norm"))
g1$kstest



## Compare AIC
AIC(mlog, msqrt, mnorm)
#SLog a better fits to the data 





#############################################################
##################        Analysis        ###################
#############################################################

mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)
summary(mod0)

mod1 <- lme4::lmer(Lambda ~ Block + (1|Population), 
                   data=data_phenotyping)
anova(mod0,mod1,test="Chisq") # difference


############ 
###### Posthoc
############ 
emmeans::emmeans(mod0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 

############ 
###### Predict
############
data_predict_extinct <- data.frame(Genetic_Diversity = levels(data_phenotyping$Genetic_Diversity),
                                   Block = "Block4")

data_predict_extinct$predict <- predict(mod0, 
                                        type = "response",
                                        re.form = NA,
                                        newdata = data_predict_extinct)

```


## Remaining He difference
```{r }

Rmisc::summarySE(data[data$Generation_Eggs==2,],
          measurevar = c("He_remain"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)


mfull <- lm(He_remain ~ Genetic_Diversity, data=data[data$Generation_Eggs==2,])
mless <- lm(He_remain ~ 1, data=data[data$Generation_Eggs==2,])
anova(mfull,mless) #Keep effect



############ 
###### Posthoc
############ 
emmeans::emmeans(mfull, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 



Rmisc::summarySE(data[data$Generation_Eggs==2,],
          measurevar = c("He_remain"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)




#Calcul for end:
Rmisc::summarySE(data[data$Generation_Eggs==2&data$Extinction_finalstatus!="yes",],
          measurevar = c("He_end"),
          groupvars = c("Genetic_Diversity"),
          na.rm=TRUE)

mfull <- lm(He_end ~ Genetic_Diversity, data=data[data$Generation_Eggs==2&data$Extinction_finalstatus!="yes",])
mless <- lm(He_end ~ 1, data=data[data$Generation_Eggs==2&data$Extinction_finalstatus!="yes",])
anova(mfull,mless) #Keep effect




############ 
###### Posthoc
############ 
emmeans::emmeans(mfull, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 






```


## Growth rate and He
```{r }
#Best model with genetic diversity
mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping)

mod0 <- lme4::lmer(Lambda ~ Genetic_Diversity + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod1 <- lme4::lmer(Lambda ~ He_end + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod2 <- lme4::lmer(Lambda ~ Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod3 <- lme4::lmer(Lambda ~ log(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod4 <- lme4::lmer(Lambda ~ 1 + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod5 <- lme4::lmer(Lambda ~ exp(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
MuMIn::model.sel(mod0, mod1,mod2,mod3,mod4,mod5)

#Makes sense: best model log He
x <- seq(1:100)
y <- seq(1001:1100)
plot(log(x),y)



#############################################################
##################        Analysis        ###################
#############################################################

mod3 <- lme4::lmer(Lambda ~ log(He_end) + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
mod4 <- lme4::lmer(Lambda ~ 1 + Block + (1|Population), 
                   data=data_phenotyping[!is.na(data_phenotyping$He_end),])
anova(mod3,mod4,test="Chisq") # difference
summary(mod3)

#############################################################
##################        Predict         ###################
#############################################################

data_predict_lambda <- data.frame(He_end =
  seq(min(data_phenotyping[!is.na(data_phenotyping$He_end),]$He_end),
      max(data_phenotyping[!is.na(data_phenotyping$He_end),]$He_end), 
      0.01),
                                   Block = "Block4")

data_predict_lambda$lambda_predict <- predict(mod3, 
                                        type = "response",
                                        re.form = NA,
                                        newdata = data_predict_lambda)
 
  PLOT_He_expect <- PLOT_He_Final +   geom_line(data = data_predict_lambda, 
                                aes(x = He_end, y = lambda_predict),
                                linetype = "longdash", col = "grey40", size = 1.25) 

# 
# #
# cowplot::save_plot(here::here("figures","Fitness_He_final.pdf"),   PLOT_He_expect,
#           base_height = 12/cm(1), base_width = 18/cm(1), dpi = 610)


```





## Adults G6 
```{r }
m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
summary(m0)

# Equivalent to:
# m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population/ID_Rep),
#                 family = "poisson", data = data_5week)


#dispersion_lme4::glmer(m0) #dispersion ok 
#Note: (1|School) + (1|Class:School) is equivalent to (1|School/Class)

m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Population) + (1|ID_Rep:Population),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") # difference

summary(m0)




############ 
###### Posthoc
############ 
emmeans::emmeans(m0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


#test double nested
m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Genetic_Diversity/Population/ID_Rep),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Genetic_Diversity/Population/ID_Rep),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") 

m0 <- lme4::glmer(Adults ~ Genetic_Diversity  + (1|Genetic_Diversity/ID_Rep),
                family = "poisson", data = data_phenotyping)
m1 <- lme4::glmer(Adults ~ 1  + (1|Genetic_Diversity/ID_Rep),
                family = "poisson", data = data_phenotyping)
anova(m0,m1,test="Chisq") 

``` 



## Adults G2 
```{r }
m0 <- glm(Nb_adults ~ Genetic_Diversity + Block,  family = "poisson", data = data[data$Generation_Eggs==2,])
summary(m0)

m1<- glm(Nb_adults ~ Block,  family = "poisson", data = data[data$Generation_Eggs==2,])
anova(m0,m1,test="Chisq") # difference

############ 
###### Posthoc
############ 
emmeans::emmeans(m0, list(pairwise ~ Genetic_Diversity), adjust = "tukey") 


``` 


